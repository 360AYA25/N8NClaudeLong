{
  "updatedAt": "2025-12-23T02:31:36.988Z",
  "createdAt": "2025-11-06T19:26:48.328Z",
  "id": "sw3Qs3Fe3JahEbbW",
  "name": "FoodTracker",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "454ac29e-dce6-43f0-82cf-2304cc20545f",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1136,
        128
      ],
      "webhookId": "1bf5d250-c832-495e-992f-12d2bf57dfbd",
      "credentials": {
        "telegramApi": {
          "id": "ofhXzaw3ObXDT5JY",
          "name": "Multi_Bot0101_bot"
        }
      }
    },
    {
      "parameters": {
        "tableId": "message_processing_log",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "message_id",
              "fieldValue": "={{ $json.message.message_id }}"
            },
            {
              "fieldId": "telegram_user_id",
              "fieldValue": "={{ $json.message.from.id }}"
            }
          ]
        }
      },
      "id": "98883f54-610b-485a-a45b-83b7bfd88a8f",
      "name": "Log Message",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -976,
        128
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "users",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_user_id",
              "keyValue": "={{ $node[\"Telegram Trigger\"].json.message.from.id }}"
            }
          ]
        }
      },
      "id": "90b986bb-f244-4a25-9d55-a3f2baa451bf",
      "name": "Check User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -800,
        128
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "04a22337-2efe-48c2-9a4f-b70b9dc6072e",
      "name": "IF Registered",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -640,
        128
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $node[\"Telegram Trigger\"].json.message.chat.id }}",
        "text": "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è: https://t.me/Multi_Bot0101_bot?start=register",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "0dc205e8-dff5-48f9-9f75-29540fa3910f",
      "name": "Not Registered",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -624,
        512
      ],
      "webhookId": "3ef5eafe-411b-4eb2-9a8c-da4e142819b2",
      "credentials": {
        "telegramApi": {
          "id": "ofhXzaw3ObXDT5JY",
          "name": "Multi_Bot0101_bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendChatAction",
        "chatId": "={{ $node[\"Telegram Trigger\"].json.message.chat.id }}"
      },
      "id": "0538def8-e810-40ec-949e-22cda344d2a7",
      "name": "Typing Indicator",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -528,
        -16
      ],
      "webhookId": "7a38b2bd-6d17-42c5-9bee-5778a2e75918",
      "credentials": {
        "telegramApi": {
          "id": "ofhXzaw3ObXDT5JY",
          "name": "Multi_Bot0101_bot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "restore-message",
              "name": "message",
              "value": "={{ $node[\"Telegram Trigger\"].json.message }}",
              "type": "object"
            },
            {
              "id": "add-user-data",
              "name": "user",
              "value": "={{ $node[\"Check User\"].json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-message-data-001",
      "name": "Prepare Message Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -400,
        -16
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-check",
                    "leftValue": "={{ $json.message.voice }}",
                    "operator": {
                      "type": "object",
                      "operation": "notEmpty"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "photo-check",
                    "leftValue": "={{ $json.message.photo }}",
                    "operator": {
                      "type": "array",
                      "operation": "notEmpty"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "photo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5583f843-611a-4021-a689-c24f16f9d03b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "start_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/help",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "fb4f5625-196d-4956-8dc6-527a5f6d5a06"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "help_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/report|/day",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    },
                    "id": "ebf5ef39-5c17-4b2f-9f3a-630310505d3c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "day_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/stats|/week",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    },
                    "id": "952b2008-7b5f-4aae-8147-5b3815e6a8d9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "week_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/settings",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "388517b7-ddca-44ad-8333-96466ea9e6a8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "settings_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/restart",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "19fc2605-705f-4733-8058-f069b5257a1f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "restart_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^/welcome",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    },
                    "id": "fed012c1-9bce-4c31-9670-fd124562a3f9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "welcome_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^/month",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    },
                    "id": "7f2eecd5-300d-40d0-aa8a-a3d9a85bed7e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "month_command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "operator": {
                      "type": "string",
                      "operation": "exists"
                    },
                    "id": "75e7b4e4-e127-4ec7-9bfb-1351ba3d9990"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -288,
        128
      ],
      "id": "52133fd5-62ec-4aaa-a265-c225274c6c16",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst message = input.message;\nconst user = input.user;\n\nif (!user || !user.telegram_user_id) {\n  throw new Error(\"User data not found in execution context\");\n}\n\nreturn [{ \n  type: 'text', \n  data: message.text, \n  telegram_user_id: user.telegram_user_id, \n  user_id: user.id, \n  owner: user.owner \n}];"
      },
      "id": "009e557b-b9d5-4087-bedd-0736f1b04544",
      "name": "Process Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        -32
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst message = input.message;\nconst user = input.user;\n\nif (!user || !user.id) {\n  throw new Error(\"User data not found in execution context\");\n}\n\nreturn [{\n  type: 'voice',\n  voice_file_id: message.voice.file_id,\n  message: message,\n  user_id: user.id,\n  telegram_user_id: user.telegram_user_id,\n  owner: user.owner\n}];"
      },
      "id": "04f2c478-b7d9-4b36-b3bb-1ee97e60fed9",
      "name": "Process Voice",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        144
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.voice_file_id }}",
        "additionalFields": {}
      },
      "id": "f0320ed4-3e52-4346-881a-2316b7af6ae2",
      "name": "Download Voice",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        192,
        144
      ],
      "webhookId": "d5682e09-d29e-47d0-9c65-552ec9dea4ca",
      "credentials": {
        "telegramApi": {
          "id": "ofhXzaw3ObXDT5JY",
          "name": "Multi_Bot0101_bot"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "8eea1509-2f8a-45f4-ba73-cece0e9b43ab",
      "name": "Transcribe Voice",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        400,
        144
      ],
      "credentials": {
        "openAiApi": {
          "id": "NPHTuT9Bime92Mku",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const transcription = $json.text;\nconst voiceData = $(\"Process Voice\").first().json;\nreturn [{\n  type: 'voice',\n  data: transcription,\n  user_id: voiceData.user_id,\n  telegram_user_id: voiceData.telegram_user_id,\n  owner: voiceData.owner\n}];"
      },
      "id": "232b4bc6-e052-4570-b15a-f6300e09a7d5",
      "name": "Merge Voice Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        592,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst message = input.message;\nconst user = input.user;\n\nif (!user || !user.id) {\n  throw new Error(\"User data not found in execution context\");\n}\n\nconst photos = message.photo;\nconst largestPhoto = photos[photos.length - 1];\nreturn [{ \n  type: 'photo', \n  photo_file_id: largestPhoto.file_id, \n  message: message, \n  user_id: user.id, \n  telegram_user_id: user.telegram_user_id, \n  owner: user.owner \n}];"
      },
      "id": "bcac5096-0cc4-42ce-93bd-4fb471ed67d9",
      "name": "Process Photo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        288
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.photo_file_id }}",
        "additionalFields": {}
      },
      "id": "d8ce2c0b-9fb4-4579-98a7-581481e29c30",
      "name": "Download Photo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        192,
        288
      ],
      "webhookId": "82c56e64-5ae0-4ee6-93b0-b7811539f5b9",
      "credentials": {
        "telegramApi": {
          "id": "ofhXzaw3ObXDT5JY",
          "name": "Multi_Bot0101_bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "barcode-check",
              "leftValue": "={{ $json.has_barcode }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a05b15c1-7b84-4eb7-895a-ec9a28219b69",
      "name": "IF Has Barcode",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        240,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const downloadedPhoto = $(\"Download Photo\").first();\nconst currentData = $input.first().json;\n\nreturn [{\n  json: {\n    ...currentData,\n    telegram_user_id: currentData.telegram_user_id\n  },\n  binary: downloadedPhoto.binary\n}];"
      },
      "id": "restore-binary-vision-001",
      "name": "Restore Binary for Vision",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        656
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "text": "Analyze this food photo. Identify the food items visible and estimate their quantities. Return in format: 'food_name: quantity unit'",
        "inputType": "base64",
        "options": {}
      },
      "id": "9364c869-f156-4214-810d-0a680db5e188",
      "name": "Vision Analysis",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        672,
        656
      ],
      "credentials": {
        "openAiApi": {
          "id": "NPHTuT9Bime92Mku",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "id": "ad709023-1205-4d27-8414-41e0590318d5",
      "name": "Merge Photo Paths",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1008,
        672
      ]
    },
    {
      "parameters": {
        "jsCode": "const visionResult = $json.content || $json.text || $json.response || $json.output;\nconst photoData = $(\"Process Photo\").first().json;\n\nreturn [{\n  type: 'photo',\n  data: visionResult,\n  source: 'vision',\n  user_id: photoData.user_id,\n  telegram_user_id: photoData.telegram_user_id,\n  owner: photoData.owner\n}];"
      },
      "id": "4c26424a-a4da-40e2-8fba-0555f1356ddb",
      "name": "Parse Vision Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        656
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "text": "Look carefully at this product image for a barcode or EAN/UPC number. If you find a barcode, return ONLY the numeric code (no text, no explanation). If no barcode is visible or readable, return exactly: NO_BARCODE",
        "inputType": "base64",
        "options": {}
      },
      "id": "e23b98c5-c49d-4d11-83e4-3ee2dab350c3",
      "name": "Extract Barcode",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        400,
        288
      ],
      "credentials": {
        "openAiApi": {
          "id": "NPHTuT9Bime92Mku",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const visionResponse = $json.content || $json.text || '';\nconst photoData = $(\"Process Photo\").first().json;\n\nconst barcodeMatch = visionResponse.match(/\\d{8,14}/);\nconst hasBarcode = barcodeMatch && visionResponse !== 'NO_BARCODE';\n\nreturn [{\n  json: {\n    barcode: hasBarcode ? barcodeMatch[0] : null,\n    has_barcode: hasBarcode,\n    user_id: photoData.user_id,\n    telegram_user_id: photoData.telegram_user_id,\n    owner: photoData.owner,\n    vision_response: visionResponse\n  },\n  binary: $input.item.binary\n}];"
      },
      "id": "7d0dc95a-b5cf-47e9-9945-b72fc691b490",
      "name": "Parse Barcode Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        592,
        320
      ]
    },
    {
      "parameters": {
        "url": "=https://world.openfoodfacts.org/api/v2/product/{{ $json.barcode }}.json",
        "options": {}
      },
      "id": "3eb4fa16-23f0-4e33-b6b9-509d315ba719",
      "name": "Get OpenFoodFacts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        496,
        528
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const offResponse = $input.first().json;\nconst photoData = $(\"Process Photo\").first().json;\n\nif (offResponse.error || offResponse.status === 0) {\n  return [{\n    json: {\n      success: false,\n      source: 'openfoodfacts',\n      error: offResponse.error || 'Product not found in OpenFoodFacts',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nif (!offResponse.product || offResponse.status !== 1) {\n  return [{\n    json: {\n      success: false,\n      source: 'openfoodfacts',\n      error: 'Product not found in OpenFoodFacts database',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: offResponse.code || $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nconst product = offResponse.product;\nconst productName = product.product_name || product.product_name_ru || product.product_name_en || 'Unknown Product';\nconst brand = product.brands || 'Unknown Brand';\n\nreturn [{\n  json: {\n    type: 'photo',\n    source: 'openfoodfacts',\n    success: true,\n    data: `${brand} - ${productName}`,\n    product_name: productName,\n    brand: brand,\n    barcode: product.code || offResponse.code,\n    calories: product.nutriments?.['energy-kcal_100g'] || 0,\n    protein: product.nutriments?.proteins_100g || 0,\n    carbs: product.nutriments?.carbohydrates_100g || 0,\n    fat: product.nutriments?.fat_100g || 0,\n    user_id: photoData.user_id,\n    telegram_user_id: photoData.telegram_user_id,\n    owner: photoData.owner,\n    raw_off_response: offResponse\n  },\n  binary: $input.item.binary\n}];"
      },
      "id": "f4b72600-dcaf-41d1-bc46-039e2e0a0739",
      "name": "Parse OpenFoodFacts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        512
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1376,
        688
      ],
      "id": "18d2242f-51eb-48c9-8d1c-1fef81ce9974",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "NPHTuT9Bime92Mku",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Save a food entry to the database.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_food_entry",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_food_item"
            },
            {
              "name": "p_quantity"
            },
            {
              "name": "p_unit"
            },
            {
              "name": "p_calories"
            },
            {
              "name": "p_protein"
            },
            {
              "name": "p_carbs"
            },
            {
              "name": "p_fats"
            },
            {
              "name": "p_fiber",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_date"
            },
            {
              "name": "p_time",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID number",
              "type": "number"
            },
            {
              "name": "p_food_item",
              "description": "Food name in Russian",
              "type": "string"
            },
            {
              "name": "p_quantity",
              "description": "Quantity as number",
              "type": "number"
            },
            {
              "name": "p_unit",
              "description": "Unit: grams, ml, or pcs",
              "type": "string"
            },
            {
              "name": "p_calories",
              "description": "Calories as number",
              "type": "number"
            },
            {
              "name": "p_protein",
              "description": "Protein in grams",
              "type": "number"
            },
            {
              "name": "p_carbs",
              "description": "Carbs in grams",
              "type": "number"
            },
            {
              "name": "p_fats",
              "description": "Fats in grams",
              "type": "number"
            },
            {
              "name": "p_fiber",
              "description": "Fiber in grams (optional)",
              "type": ""
            },
            {
              "name": "p_date",
              "description": "Date in YYYY-MM-DD format",
              "type": "string"
            },
            {
              "name": "p_time",
              "description": "Time in HH:MM format (optional)",
              "type": ""
            }
          ]
        }
      },
      "id": "cccfae9d-4439-438c-9471-baf194b83445",
      "name": "Save Food Entry",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        2432,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Check User').first().json.telegram_user_id }}",
        "contextWindowLength": 10
      },
      "id": "memory-buffer-node-001",
      "name": "Conversation Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        1520,
        688
      ],
      "credentials": {
        "postgres": {
          "id": "YfW5ar1A5pmUD0If",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "## CRITICAL: SESSION DETECTION LOGIC\n\n**How to detect if you're in a session:**\n\n1. **Check conversation history** - Did user start with `/welcome`, `/settings`, or `/meals`?\n2. **Check input context** - Is there a `session_mode` field?\n3. **Apply session-specific rules** (see below)\n\n**General rules for ALL sessions:**\n- ‚úÖ **ALWAYS** use `telegram_user_id` from input context (NEVER null!)\n- ‚úÖ **REMEMBER** everything from THIS CURRENT conversation\n- ‚ùå **IGNORE** previous attempts of SAME command from conversation history\n\n---\n\n## ‚ö†Ô∏è CRITICAL: RESPONSE STYLE (MANDATORY!)\n\n- Friendly Russian tone\n- **MANDATORY emojis in EVERY response:** üìäü•©üçûüßàüåæüíß\n- Concise (2-3 sentences max)\n- Macro format: \"–ë–µ–ª–∫–∏: XX–≥ ü•© | –£–≥–ª–µ–≤–æ–¥—ã: XX–≥ üçû | –ñ–∏—Ä—ã: XX–≥ üßà | –ö–∞–ª–æ—Ä–∏–∏: XX–∫–∫–∞–ª üìä | –ö–ª–µ—Ç—á–∞—Ç–∫–∞: XX–≥ üåæ | –í–æ–¥–∞: XXX–º–ª üíß\"\n\n---\n\n## SESSION TYPE: /welcome\n\n**Detection:**\n- User sent `/welcome` command, OR\n- Input context has `session_mode: \"/welcome\"`, OR\n- Conversation history shows you asked onboarding questions\n\n**Rules during /welcome:**\n- ‚úÖ **USE** `telegram_user_id` from input context (required for database!)\n- ‚ùå **IGNORE** `user_goals` and `user_profile` from input context (OLD data from previous onboarding!)\n- ‚úÖ **REMEMBER** all 12 answers from THIS CURRENT conversation (6 profile + 6 macros)\n- ‚ùå **IGNORE** previous /welcome sessions from conversation history (old attempts)\n\n**Why:** User is updating their ENTIRE profile. Old database values would confuse you about what data to save.\n\n**Example flow:**\n```\nUser: /welcome\nYou: \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\nUser: \"–°–µ—Ä–≥–µ–π\"\nYou remember: name = \"–°–µ—Ä–≥–µ–π\" ‚úÖ\n\n[... 11 more questions ...]\n\nYou show confirmation with ALL 12 values from THIS conversation\nUser: \"–¥–∞\"\n\nTool call: {\n  p_telegram_user_id: 682776858,  ‚Üê from input context ‚úÖ\n  p_name: \"–°–µ—Ä–≥–µ–π\",                ‚Üê from THIS conversation ‚úÖ\n  p_age: 87,                        ‚Üê from THIS conversation ‚úÖ\n  ... (all from THIS conversation, NOT from input context!)\n}\n```\n\n---\n\n## SESSION TYPE: /settings\n\n**What can be changed:**\n- Goal (weight_loss / maintenance / muscle_gain)\n- Weight (kg)\n- Timezone (IANA format)\n- Macro goals (calories, protein, carbs, fat, fiber, water)\n\n**Detection:**\n- User sent `/settings` command, OR\n- Input context has `session_mode: \"/settings\"`, OR\n- User asked to change specific settings\n\n**Rules during /settings:**\n- ‚úÖ **USE** `telegram_user_id` from input context\n- üî¥ **CRITICAL:** READ `user_goals` and `user_profile` from INPUT CONTEXT and SHOW real values to user!\n- ‚úÖ **SHOW** current values from ALL settings: goal, weight, timezone, macros (so user knows what to change)\n- ‚ùå **DO NOT** use placeholders like [Your Goal] - use REAL values from input context!\n- ‚úÖ **REMEMBER** what user wants to CHANGE from THIS conversation\n- ‚ö†Ô∏è **UPDATE** only changed fields, keep everything else from database\n- üìä **CRITICAL:** ALWAYS use emojis in output! (see Response Style section)\n- üá∑üá∫ **CRITICAL:** ALWAYS respond in RUSSIAN, NEVER in English!\n\n**Why:** User is changing 1-2 fields. You need to show CURRENT state, but only update what they explicitly change.\n\n**Example flow:**\n```\nUser: /settings\nInput context: {user_goals: {protein: 140, carbs: 246, ...}, user_profile: {goal: \"weight_loss\", timezone: \"Europe/Moscow\", name: \"–°–µ—Ä–≥–µ–π\", age: 66, height_cm: 188, weight_kg: 98, ...}}\n\nYou: \"–í–æ—Ç —Ç–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n\n1. –ò–º—è: –°–µ—Ä–≥–µ–π\n2. –í–æ–∑—Ä–∞—Å—Ç: 66 –ª–µ—Ç\n3. –†–æ—Å—Ç: 188 —Å–º\n4. –í–µ—Å: 98 –∫–≥\n5. –¶–µ–ª—å: –ø–æ—Ö—É–¥–µ–Ω–∏–µ\n6. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Europe/Moscow\n7. –ö–∞–ª–æ—Ä–∏–∏: 110 –∫–∫–∞–ª üìä\n8. –ë–µ–ª–∫–∏: 122–≥ ü•©\n9. –£–≥–ª–µ–≤–æ–¥—ã: 24–≥ üçû\n10. –ñ–∏—Ä—ã: 34–≥ üßà\n11. –ö–ª–µ—Ç—á–∞—Ç–∫–∞: 54–≥ üåæ\n12. –í–æ–¥–∞: 2100–º–ª üíß\n\n–ß—Ç–æ —Ö–æ—á–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å?\"\n\nUser: \"—Ö–æ—á—É –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã\"\nYou remember: user wants to change GOAL to \"muscle_gain\" ‚úÖ\n\nTool call: Update User Goal {\n  p_telegram_user_id: 682776858,  ‚Üê from input context ‚úÖ\n  p_goal: \"muscle_gain\"           ‚Üê from THIS conversation ‚úÖ\n}\n```\n\n---\n\n## SESSION TYPE: /meals\n\n**Detection:**\n- User sent `/meals` command, OR\n- Input context has `session_mode: \"/meals\"`, OR\n- User is adding/editing/deleting meal templates\n\n**Rules during /meals:**\n- ‚úÖ **USE** `telegram_user_id` from input context\n- ‚úÖ **REMEMBER** meal data collected from THIS conversation (name, ingredients, macros)\n- Use appropriate tools: Add User Meal, Update User Meal, Delete User Meal, Search User Meals\n\n**Why:** User is creating/editing custom meal templates. Need to collect multiple fields through dialog.\n\n**Example flow:**\n```\nUser: /meals\nYou: \"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –±–ª—é–¥. –ö–æ–º–∞–Ω–¥—ã: –¥–æ–±–∞–≤–∏—Ç—å/–Ω–∞–π—Ç–∏/–∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å\"\n\nUser: \"–¥–æ–±–∞–≤–∏—Ç—å –æ–º–ª–µ—Ç\"\nYou: \"–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ —Ç–≤–æ–µ–º –æ–º–ª–µ—Ç–µ?\"\nYou remember: meal_name = \"–æ–º–ª–µ—Ç\" ‚úÖ\n\nUser: \"3 —è–π—Ü–∞, 50–º–ª –º–æ–ª–æ–∫–∞\"\nYou remember: ingredients = \"3 —è–π—Ü–∞, 50–º–ª –º–æ–ª–æ–∫–∞\" ‚úÖ\n\nTool call: Add User Meal {\n  p_telegram_user_id: 682776858,     ‚Üê from input context ‚úÖ\n  p_meal_name: \"–æ–º–ª–µ—Ç\",              ‚Üê from THIS conversation ‚úÖ\n  p_ingredients: \"3 —è–π—Ü–∞, 50–º–ª –º–æ–ª–æ–∫–æ\" ‚Üê from THIS conversation ‚úÖ\n}\n```\n\n---\n\n## NORMAL MODE (no session)\n\n**When:** User sends regular messages (food logs, questions, reports)\n\n**Rules:**\n- ‚úÖ **USE** full context from input: `telegram_user_id`, `user_goals`, `user_profile`, `user_name`\n- ‚úÖ **USE** conversation history normally\n- Use tools as needed for food logging, reports, etc.\n\n---\n\n## Role Definition\n\nYou are a helpful AI nutrition coach for a food tracking Telegram bot.\nYou help users track meals, calculate macros, set goals, and manage nutrition.\n\n---\n\n## Available Tools (15):\n\n### Food Management:\n1. **Save Food Entry** - Log food (p_telegram_user_id, p_product_name, p_quantity_g, p_protein, p_carbs, p_fat, p_calories, p_fiber?, p_time?)\n2. **Search Food by Product** - Find entries (p_telegram_user_id, p_product_name)\n3. **Search Similar Entries** - Similar foods (p_telegram_user_id, p_product_name)\n4. **Search Today Entries** - Today's log (p_telegram_user_id)\n5. **Delete Food Entry** - Remove entry (p_telegram_user_id, p_entry_id)\n\n### Reports:\n6. **Get Daily Summary** - Daily report (p_telegram_user_id, p_date)\n7. **Get Monthly Summary** - Monthly report (p_telegram_user_id, p_year_month)\n\n### Settings:\n8. **Update User Goal** - Change goal (p_telegram_user_id, p_goal: \"weight_loss\"/\"maintenance\"/\"muscle_gain\")\n9. **Update User Timezone** - Change timezone (p_telegram_user_id, p_timezone: IANA format)\n10. **Update User Onboarding** - Complete onboarding (13 params - see /welcome section, includes user-provided calories_goal)\n\n### Meal Planning:\n11. **Add User Meal** - Create template (p_telegram_user_id, p_meal_name, p_ingredients)\n12. **Search User Meals** - Find templates (p_telegram_user_id, p_search_term?)\n13. **Update User Meal** - Edit template (p_telegram_user_id, p_meal_id, p_meal_name?, p_ingredients?)\n14. **Delete User Meal** - Remove template (p_telegram_user_id, p_meal_id)\n\n### Water:\n15. **Log Water Intake** - Track water (p_telegram_user_id, p_amount_ml, p_time?)\n\n---\n\n## /welcome Command Details\n\n**MANDATORY CHECKLIST before calling Update User Onboarding:**\n- [ ] Asked ALL 6 profile questions (a-f)\n- [ ] Asked ALL 6 macro questions (g-l)\n- [ ] Converted timezone to IANA format\n- [ ] Have `telegram_user_id` from input context\n\n**Question Sequence (ONE BY ONE):**\n\n**Profile (6):**\na) \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\" ‚Üí name\nb) \"–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?\" ‚Üí age\nc) **[MANDATORY!]** \"–ö–∞–∫–æ–π —É —Ç–µ–±—è —Ä–æ—Å—Ç –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö?\" ‚Üí height_cm\nd) \"–°–∫–æ–ª—å–∫–æ —Ç—ã –≤–µ—Å–∏—à—å? (–≤ –∫–≥)\" ‚Üí weight_kg\ne) \"–ö–∞–∫–∞—è —É —Ç–µ–±—è —Ü–µ–ª—å?\" (–ø–æ—Ö—É–¥–µ–Ω–∏–µ/–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ/–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã) ‚Üí goal\nf) \"–í –∫–∞–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ?\" ‚Üí timezone\n\n**Macros (6):**\ng) –ö–∞–ª–æ—Ä–∏–∏ ‚Üí calories_goal\nh) –ë–µ–ª–∫–∏ ‚Üí protein_goal\ni) –£–≥–ª–µ–≤–æ–¥—ã ‚Üí carbs_goal\nj) –ñ–∏—Ä—ã ‚Üí fat_goal\nk) –ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üí fiber_goal\nl) –í–æ–¥–∞ (–º–ª) ‚Üí water_goal_ml\n\n**Timezone Conversion:**\n- –ú–æ–Ω—Ä–µ–∞–ª—å ‚Üí America/Toronto\n- –ú–æ—Å–∫–≤–∞ ‚Üí Europe/Moscow\n- –ö–∏–µ–≤ ‚Üí Europe/Kiev\n\n**Macro Calculation (optional offer - but ALWAYS ask user for final values):**\n‚ö†Ô∏è **CRITICAL:** You can OFFER to calculate macros, but MUST ask user for FINAL values. NO auto-calculation in database!\n\n**Suggested formulas (offer, but let user decide):**\n- Calories: weight √ó 22/27/32 (loss/maintain/gain) - **ASK user for their target!**\n- Protein: weight √ó 1.6 (or √ó2.0 for muscle_gain)\n- Carbs: (calories √ó 0.50) / 4\n- Fat: (calories √ó 0.25) / 9\n- Fiber: 25-30g\n- Water: weight √ó 30ml (min 2000)\n\n**Example dialog:**\n\"–î–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é 1430 –∫–∫–∞–ª (65–∫–≥ √ó 22). –°–æ–≥–ª–∞—Å–µ–Ω –∏–ª–∏ —Ö–æ—á–µ—à—å –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ?\"\nUser: \"1430 –Ω–æ—Ä–º\" ‚Üê Save 1430 to database\n\n**MANDATORY CONFIRMATION FORMAT:**\n```\n–û—Ç–ª–∏—á–Ω–æ, [name]! –ü—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ:\n1. –ò–º—è: [name]\n2. –í–æ–∑—Ä–∞—Å—Ç: [age]\n3. –†–æ—Å—Ç: [height] —Å–º\n4. –í–µ—Å: [weight] –∫–≥\n5. –¶–µ–ª—å: [goal_ru]\n6. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: [timezone]\n7. –ö–∞–ª–æ—Ä–∏–∏: [calories] –∫–∫–∞–ª üìä\n8. –ë–µ–ª–∫–∏: [protein]–≥ ü•©\n9. –£–≥–ª–µ–≤–æ–¥—ã: [carbs]–≥ üçû\n10. –ñ–∏—Ä—ã: [fat]–≥ üßà\n11. –ö–ª–µ—Ç—á–∞—Ç–∫–∞: [fiber]–≥ üåæ\n12. –í–æ–¥–∞: [water]–º–ª üíß\n\n–í—Å–µ –≤–µ—Ä–Ω–æ?\n```\n\n**After saving:** \"‚úÖ –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\"\n\n---\n\n## Error Handling\n\n- If tool returns error ‚Üí explain simply in Russian\n- Suggest alternative actions\n- Never expose technical details to user\n\n---\n\n## Important Notes\n\n- **p_telegram_user_id:** ALWAYS from input context, NEVER null!\n- Tool parameters use `p_` prefix\n- Optional params (p_fiber, p_time): pass null if not provided\n- Timezone MUST be IANA format\n- Height (height_cm) is MANDATORY in /welcome\n"
        }
      },
      "id": "cdfe74df-5815-4557-bf8f-f0213d9ca8ad",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1456,
        352
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "openfoodfacts-success-check",
              "leftValue": "={{ $json.success }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-openfoodfacts-success-001",
      "name": "IF OpenFoodFacts Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1008,
        496
      ]
    },
    {
      "parameters": {
        "jsCode": "const downloadedPhoto = $(\"Download Photo\").first();\nconst currentData = $input.first().json;\n\nreturn [{\n  json: {\n    ...currentData,\n    barcode: currentData.barcode,\n    user_id: currentData.user_id,\n    telegram_user_id: currentData.telegram_user_id\n  },\n  binary: downloadedPhoto.binary\n}];"
      },
      "id": "restore-binary-upc-001",
      "name": "Restore Binary for UPC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        960
      ]
    },
    {
      "parameters": {
        "url": "=https://api.upcitemdb.com/prod/trial/lookup?upc={{ $json.barcode }}",
        "options": {}
      },
      "id": "get-upc-database-001",
      "name": "Get UPC Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1280,
        960
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const upcResponse = $input.first().json;\nconst photoData = $(\"Process Photo\").first().json;\n\nif (upcResponse.error || upcResponse.code === 'INVALID_UPC') {\n  return [{\n    json: {\n      success: false,\n      source: 'upc_database',\n      error: upcResponse.error || 'Product not found in UPC database',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nif (upcResponse.code === 'RATE_LIMIT_EXCEEDED') {\n  return [{\n    json: {\n      success: false,\n      source: 'upc_database',\n      error: 'UPC Database rate limit exceeded (100/day)',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nconst item = upcResponse.items?.[0];\nif (!item) {\n  return [{\n    json: {\n      success: false,\n      source: 'upc_database',\n      error: 'Empty response from UPC database',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nconst rawBarcode = $(\"Parse Barcode Result\").first().json.barcode;\nconst upcBarcode = (rawBarcode.startsWith('0') && rawBarcode.length === 13) ? rawBarcode.substring(1) : rawBarcode;\n\nreturn [{\n  json: {\n    type: 'photo',\n    source: 'upc_database',\n    success: true,\n    data: `${item.brand || 'Unknown'} - ${item.title}`,\n    product_name: item.title,\n    brand: item.brand,\n    category: item.category,\n    barcode: upcBarcode,\n    user_id: photoData.user_id,\n    telegram_user_id: photoData.telegram_user_id,\n    owner: photoData.owner,\n    raw_upc_response: upcResponse\n  },\n  binary: $input.item.binary\n}];"
      },
      "id": "parse-upc-response-001",
      "name": "Parse UPC Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        960
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "upc-success-check",
              "leftValue": "={{ $json.success }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-upc-success-001",
      "name": "IF UPC Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1616,
        976
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_conversation_message",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ p_user_id: $('Prepare Message Data').first().json.user.id, p_role: 'user', p_content: $('Telegram Trigger').first().json.message.text || $('Telegram Trigger').first().json.message.caption || 'photo/voice message' }) }}",
        "options": {}
      },
      "id": "save-user-message-001",
      "name": "Save User Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2592,
        144
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rDcjW0UFczbmWtVq",
          "name": "Supabase Header Auth"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_conversation_message",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ p_user_id: $('Prepare Message Data').first().json.user.id, p_role: 'assistant', p_content: $('AI Agent').first().json.output || '' }) }}",
        "options": {}
      },
      "id": "save-ai-response-001",
      "name": "Save AI Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2384,
        144
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "rDcjW0UFczbmWtVq",
          "name": "Supabase Header Auth"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Inject Context with Session State Tracking\n// FIXED: Adds user data INSIDE chatInput so AI Agent can see it\n\n// === CONFIG ===\nconst SUPABASE_URL = 'https://qyemyvplvtzpukvktkae.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5ZW15dnBsdnR6cHVrdmt0a2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3OTQ3MTQsImV4cCI6MjA0ODM3MDcxNH0.SV5u6EIu9k9bBHmI4LObbJqoecFNlgH4v23fwuiLAXY';\n\n// === EXTRACT USER MESSAGE ===\nconst userMessage = $json.data ||               // Process Text (most common!)\n                   $json.command ||             // Week Calculations Code\n                   $json.message?.text ||       // Direct from Telegram Trigger\n                   $json.chatInput ||           // From AI Agent input\n                   $json.transcription ||       // From Voice processing  \n                   $json.product_name ||        // From Photo processing\n                   '';\n\nconst userProfile = $node['Check User'].json;\nconst telegramUserId = userProfile.telegram_user_id;\n\n// === SESSION STATE FUNCTIONS ===\nasync function getSession() {\n  try {\n    const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_user_session`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': SUPABASE_KEY,\n        'Authorization': `Bearer ${SUPABASE_KEY}`\n      },\n      body: JSON.stringify({ p_telegram_user_id: telegramUserId })\n    });\n    return await response.json();\n  } catch (e) {\n    return {};\n  }\n}\n\nasync function startSession(command) {\n  try {\n    await fetch(`${SUPABASE_URL}/rest/v1/rpc/start_user_session`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': SUPABASE_KEY,\n        'Authorization': `Bearer ${SUPABASE_KEY}`\n      },\n      body: JSON.stringify({ p_telegram_user_id: telegramUserId, p_command: command })\n    });\n  } catch (e) {}\n}\n\n// === MAIN LOGIC ===\nconst isCommandStart = userMessage.trim().startsWith('/');\nlet session = await getSession();\n\n// If new command, start new session\nif (isCommandStart) {\n  const command = userMessage.trim().split(' ')[0].toLowerCase();\n  await startSession(command);\n  session = { active_command: command };\n}\n\n// Check if in session mode (e.g., /welcome flow)\nconst inSessionMode = session && session.active_command;\nconst isWelcomeMode = inSessionMode && session.active_command === '/welcome';\n\n// === BUILD CHAT INPUT WITH CONTEXT ===\nlet chatInput = userMessage;\n\n// For /settings and normal mode, ADD user data to chatInput so AI can see it\nif (!isWelcomeMode) {\n  const goalRu = userProfile.goal === 'weight_loss' ? '–ø–æ—Ö—É–¥–µ–Ω–∏–µ' :\n                 userProfile.goal === 'maintenance' ? '–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ' :\n                 userProfile.goal === 'muscle_gain' ? '–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã' : userProfile.goal;\n  \n  chatInput = userMessage + '\\n\\n<user_context>\\ntelegram_user_id: ' + telegramUserId + '\\nname: ' + (userProfile.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nage: ' + (userProfile.age || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nheight_cm: ' + (userProfile.height_cm || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nweight_kg: ' + (userProfile.weight_kg || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\ngoal: ' + goalRu + '\\ntimezone: ' + (userProfile.timezone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nprotein_goal: ' + (userProfile.protein_goal || 0) + '\\ncarbs_goal: ' + (userProfile.carbs_goal || 0) + '\\nfat_goal: ' + (userProfile.fat_goal || 0) + '\\nfiber_goal: ' + (userProfile.fiber_goal || 0) + '\\nwater_goal_ml: ' + (userProfile.water_goal_ml || 0) + '\\ncalorie_goal: ' + (userProfile.calorie_goal || 0) + '\\n</user_context>';\n}\n\n// === BUILD OUTPUT ===\nconst output = {\n  chatInput: chatInput,\n  user_id: userProfile.id,\n  telegram_user_id: telegramUserId\n};\n\nif (inSessionMode) {\n  output.session_mode = session.active_command;\n}\n\nreturn output;"
      },
      "id": "inject-context-001",
      "name": "Inject Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        352
      ]
    },
    {
      "parameters": {
        "toolDescription": "Search user's food entries by product name and optional date range.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_food_by_product",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_search_text"
            },
            {
              "name": "p_start_date",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_end_date",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID",
              "type": "number"
            },
            {
              "name": "p_search_text",
              "description": "Food product name to search for",
              "type": "string"
            },
            {
              "name": "p_start_date",
              "description": "Start date in YYYY-MM-DD format",
              "type": "string"
            },
            {
              "name": "p_end_date",
              "description": "End date in YYYY-MM-DD format",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-search-food-product-001",
      "name": "Search Food by Product",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        2288,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Find similar food entries from user's history.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_similar_entries",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_search_text"
            },
            {
              "name": "p_limit",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID",
              "type": "number"
            },
            {
              "name": "p_search_text",
              "description": "Food item name to search",
              "type": "string"
            },
            {
              "name": "p_limit",
              "description": "Maximum results (default 5)",
              "type": "number"
            }
          ]
        }
      },
      "id": "tool-search-similar-001",
      "name": "Search Similar Entries",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        2576,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Get all food entries for a specific date.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_today_entries",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_date",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID",
              "type": "number"
            },
            {
              "name": "p_date",
              "description": "Date in YYYY-MM-DD format",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-search-today-001",
      "name": "Search Today Entries",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        2736,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Get daily nutrition summary.\n\nUSE THIS when user asks for: /day, –¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞, —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ, daily report.\n\nALSO USE THIS FOR /week COMMAND:\n- For /week, call this tool 7 times (once per day for last 7 days)\n- Each call needs p_telegram_user_id AND p_date (YYYY-MM-DD)\n- Aggregate all results: SUM entry counts, SUM all macros\n- Calculate averages: total / 7\n\nREQUIRED PARAMETERS:\n- p_telegram_user_id (number): User's Telegram ID from context\n- p_date (YYYY-MM-DD): Date for the summary - ALWAYS provide, use today if not specified\n\nRETURNS: calories, protein, carbs, fat, fiber, water, entry_count, food entries for specified date.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/get_daily_summary",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_date"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "Users Telegram ID",
              "type": "number"
            },
            {
              "name": "p_date",
              "description": "Date for the summary in YYYY-MM-DD format. REQUIRED - always provide todays date if user doesnt specify",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-daily-summary-001",
      "name": "Get Daily Summary",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        2896,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Update user's daily nutrition goals.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_goals_bulk",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_protein_goal",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_carbs_goal",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_fat_goal",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_fiber_goal",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_water_goal_ml",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_calorie_goal",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User Telegram ID",
              "type": "number"
            },
            {
              "name": "p_protein_goal",
              "description": "Daily protein goal in grams (optional)",
              "type": "number"
            },
            {
              "name": "p_carbs_goal",
              "description": "Daily carbs goal in grams (optional)",
              "type": "number"
            },
            {
              "name": "p_fat_goal",
              "description": "Daily fat goal in grams (optional)",
              "type": "number"
            },
            {
              "name": "p_fiber_goal",
              "description": "Daily fiber goal in grams (optional)",
              "type": "number"
            },
            {
              "name": "p_water_goal_ml",
              "description": "Daily water goal in ml (optional)",
              "type": "number"
            },
            {
              "name": "p_calorie_goal",
              "description": "Custom daily calorie goal (optional)",
              "type": "number"
            }
          ]
        }
      },
      "id": "tool-update-goal-001",
      "name": "Update User Goal",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        2144,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "id": "execute-subworkflow-trigger-001",
      "name": "Execute Sub-workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -1136,
        320
      ]
    },
    {
      "parameters": {
        "toolDescription": "Delete a specific food entry by its ID.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/delete_food_entry",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_entry_id"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID",
              "type": "number"
            },
            {
              "name": "p_entry_id",
              "description": "UUID of the food entry to delete",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-delete-food-entry-001",
      "name": "Delete Food Entry",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1984,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Log water intake in milliliters.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/log_water_intake",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_amount_ml"
            },
            {
              "name": "p_intake_date",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID",
              "type": "number"
            },
            {
              "name": "p_amount_ml",
              "description": "Water amount in milliliters",
              "type": "number"
            },
            {
              "name": "p_intake_date",
              "description": "Date in YYYY-MM-DD format",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-log-water-001",
      "name": "Log Water Intake",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1824,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const output = $input.first().json.output || '';\n\nconst signatures = [\n  /This message was sent automatically with n8n\\.?\\s*/gi,\n  /This message was sent automatically\\.?\\s*/gi,\n  /Sent via n8n\\.?\\s*/gi,\n  /Sent automatically with n8n\\.?\\s*/gi,\n  /Powered by n8n\\.?\\s*/gi,\n  /Generated with n8n\\.?\\s*/gi,\n  /Generated by n8n\\.?\\s*/gi,\n  /\\n*-+\\s*This message.*$/gi,\n  /\\n*\\*This message.*$/gi,\n  /\\n{2,}This message\\..*$/gi,\n  /\\n*---+\\s*$/g,\n  /\\n*\\*{3,}\\s*$/g\n];\n\nlet cleaned = output;\n\nsignatures.forEach(pattern => {\n  cleaned = cleaned.replace(pattern, '');\n});\n\ncleaned = cleaned.trim();\ncleaned = cleaned.replace(/\\n{3,}/g, '\\n\\n');\n\nconst signatureRemoved = output !== cleaned;\n\nreturn [{ \n  json: { \n    output: cleaned,\n    original_output: signatureRemoved ? output : undefined,\n    signature_removed: signatureRemoved\n  } \n}];"
      },
      "id": "strip-signature-001",
      "name": "Strip Signature",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1696,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "const message = $input.item.json.message;\nconst command = message.text;\nconst chat_id = message.chat.id;\nconst telegram_user_id = message.from.id;\n\n// Commands that need AI Agent processing\nconst needsAIAgent = [\n  '/welcome', '/settings', '/start', '/meals', '/timezone',\n  '/week', '/stats', '/day', '/report', '/month'\n];\n\n// Check if any needsAI command matches (for commands that may have args)\nconst needsAI = needsAIAgent.some(cmd => command.startsWith(cmd));\n\nlet output = '';\n\n// Command handlers\nif (command === '/help') {\n  output = `ü§ñ **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º**\n\nüìù **–ó–∞–ø–∏—Å—å –µ–¥—ã:**\n‚Ä¢ –¢–µ–∫—Å—Ç–æ–º: \"200–≥ –∫—É—Ä–∏—Ü—ã\" –∏–ª–∏ \"—è–±–ª–æ–∫–æ\"\n‚Ä¢ –ì–æ–ª–æ—Å–æ–º: –æ—Ç–ø—Ä–∞–≤—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n‚Ä¢ –§–æ—Ç–æ: —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –±–ª—é–¥–æ\n\nüìä **–û—Ç—á—ë—Ç—ã:**\n‚Ä¢ /day - –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç (% –æ—Ç —Ü–µ–ª–∏)\n‚Ä¢ /week - –Ω–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n‚Ä¢ /month - –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç —Å —Ç—Ä–µ–Ω–¥–∞–º–∏\n\nüíß **–í–æ–¥–∞:**\n–ù–∞–ø–∏—à–∏ \"200–º–ª –≤–æ–¥—ã\" –∏–ª–∏ \"—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã\"\n\n‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**\n‚Ä¢ /settings - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–≤–µ—Å, —Ü–µ–ª—å, –º–∞–∫—Ä–æ—Å—ã)\n‚Ä¢ /welcome - –ø—Ä–æ–π—Ç–∏ onboarding –∑–∞–Ω–æ–≤–æ\n\nüìã **–®–∞–±–ª–æ–Ω—ã:**\n‚Ä¢ /meals - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –±–ª—é–¥\n\nüåç **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:**\n–í—Ä–µ–º—è –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è /welcome`;\n} else if (command === '/start') {\n  output = '–ü—Ä–∏–≤–µ—Ç! –Ø FoodTracker –±–æ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π /help —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.';\n} else if (command === '/settings') {\n  output = '–ó–∞–≥—Ä—É–∂–∞—é —Ç–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...';\n} else if (command === '/welcome') {\n  output = '–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å onboarding...';\n} else if (command === '/meals') {\n  output = '–ó–∞–≥—Ä—É–∂–∞—é —à–∞–±–ª–æ–Ω—ã –±–ª—é–¥...';\n} else if (command.startsWith('/day') || command.startsWith('/report')) {\n  output = 'üìä –§–æ—Ä–º–∏—Ä—É—é –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç...';\n} else if (command.startsWith('/week') || command.startsWith('/stats')) {\n  output = 'üìà –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é –Ω–µ–¥–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...';\n} else if (command.startsWith('/month')) {\n  output = 'üìÖ –§–æ—Ä–º–∏—Ä—É—é –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç...';\n} else {\n  output = `–ö–æ–º–∞–Ω–¥–∞ ${command} –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.`;\n}\n\nreturn {\n  json: {\n    output: output,\n    chat_id: chat_id,\n    telegram_user_id: telegram_user_id,\n    command: command,\n    needsAI: needsAI\n  }\n};"
      },
      "id": "simple-reply-001",
      "name": "Simple Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -416
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "route-check",
              "leftValue": "={{ $json.needsAI }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "route-to-ai-check-001",
      "name": "Route to AI?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        288,
        -416
      ]
    },
    {
      "parameters": {
        "toolDescription": "Updates user's timezone.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_timezone",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_timezone"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID number",
              "type": "number"
            },
            {
              "name": "p_timezone",
              "description": "IANA timezone string",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-update-timezone-001",
      "name": "Update User Timezone",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        3040,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Add new meal to user's personal meal library.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/add_user_meal_flat",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_user_id"
            },
            {
              "name": "p_meal_name"
            },
            {
              "name": "p_slang_names",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_calories_per_100g"
            },
            {
              "name": "p_protein_per_100g"
            },
            {
              "name": "p_carbs_per_100g"
            },
            {
              "name": "p_fat_per_100g"
            },
            {
              "name": "p_fiber_per_100g",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_default_portion_g",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_portion_name",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_user_id",
              "description": "Telegram user ID",
              "type": "number"
            },
            {
              "name": "p_meal_name",
              "description": "Full meal name in Russian",
              "type": "string"
            },
            {
              "name": "p_slang_names",
              "description": "Comma-separated slang names",
              "type": "string"
            },
            {
              "name": "p_calories_per_100g",
              "description": "Calories per 100g",
              "type": "number"
            },
            {
              "name": "p_protein_per_100g",
              "description": "Protein grams per 100g",
              "type": "number"
            },
            {
              "name": "p_carbs_per_100g",
              "description": "Carbohydrates grams per 100g",
              "type": "number"
            },
            {
              "name": "p_fat_per_100g",
              "description": "Fat grams per 100g",
              "type": "number"
            },
            {
              "name": "p_fiber_per_100g",
              "description": "Fiber grams per 100g",
              "type": "number"
            },
            {
              "name": "p_default_portion_g",
              "description": "Default portion size in grams",
              "type": "number"
            },
            {
              "name": "p_portion_name",
              "description": "Portion description",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-add-user-meal-001",
      "name": "Add User Meal",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        3184,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Search user's personal meal library by meal name or ingredients.\n\nCRITICAL INSTRUCTION: When user mentions a food item in ANY grammatical form, extract the ROOT/STEM before searching:\n- \"—Å —è–π—Ü–∞–º–∏\" -> search \"—è–π—Ü\"\n- \"—Å –±–µ–∫–æ–Ω–æ–º\" -> search \"–±–µ–∫–æ–Ω\"\n- \"–±–ª—é–¥–æ —Å –∫—É—Ä–∏—Ü–µ–π\" -> search \"–∫—É—Ä–∏—Ü\"\n\nRussian language has 6 cases - search must use word root to match nominative form in database.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_user_meals",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_user_id"
            },
            {
              "name": "p_query"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_user_id",
              "description": "User's Telegram ID",
              "type": "number"
            },
            {
              "name": "p_query",
              "description": "Search query (meal name or ingredient)",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-search-user-meals-001",
      "name": "Search User Meals",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        3344,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Update existing meal in user's library.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_meal",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_meal_id"
            },
            {
              "name": "p_updates"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_meal_id",
              "description": "UUID of the meal to update",
              "type": "string"
            },
            {
              "name": "p_updates",
              "description": "JSONB object with fields to update",
              "type": "object"
            }
          ]
        }
      },
      "id": "tool-update-user-meal-001",
      "name": "Update User Meal",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        3504,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Delete a meal from user's personal library.\n\nWORKFLOW (MANDATORY):\n1. FIRST call Search User Meals tool to find the meal by name\n2. Extract meal_id from search result\n3. THEN call this tool with the meal_id parameter\n\nExample: User says \"–£–¥–∞–ª–∏ –Ø–∏—á–Ω–∏—Ü—É\"\n- Step 1: search_user_meals(p_query=\"–Ø–∏—á–Ω–∏—Ü\")\n- Step 2: Get meal_id from result (e.g., \"abc-123\")\n- Step 3: delete_user_meal(p_meal_id=\"abc-123\")",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/delete_user_meal",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_meal_id"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_meal_id",
              "description": "UUID of the meal to delete",
              "type": "string"
            }
          ]
        }
      },
      "id": "tool-delete-user-meal-001",
      "name": "Delete User Meal",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        3664,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Get monthly nutrition summary. USE THIS when user asks for: /month, –º–µ—Å—è—á–Ω–∞—è —Å–≤–æ–¥–∫–∞, –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç, monthly report. Returns: 30-day averages, trends, achievements, compliance stats.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/get_monthly_summary",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_year",
              "valueProvider": "modelOptional"
            },
            {
              "name": "p_month",
              "valueProvider": "modelOptional"
            }
          ]
        },
        "placeholderDefinitions": {
          "values": [
            {
              "name": "p_telegram_user_id",
              "description": "User's Telegram ID number",
              "type": "number"
            },
            {
              "name": "p_year",
              "description": "Year for the report",
              "type": "number"
            },
            {
              "name": "p_month",
              "description": "Month 1-12 for the report",
              "type": "number"
            }
          ]
        }
      },
      "id": "tool-get-monthly-summary-001",
      "name": "Get Monthly Summary",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1680,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Updates user profile and macro goals during onboarding. Saves 13 parameters: telegram_user_id, name, age, height_cm, weight_kg, goal, calories_goal (user-provided), protein_goal, carbs_goal, fat_goal, fiber_goal, water_goal_ml, timezone. NO auto-calculation - saves exact calories value provided by user.",
        "method": "POST",
        "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_onboarding",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "p_telegram_user_id"
            },
            {
              "name": "p_name"
            },
            {
              "name": "p_age"
            },
            {
              "name": "p_height_cm"
            },
            {
              "name": "p_weight_kg"
            },
            {
              "name": "p_goal"
            },
            {
              "name": "p_calories_goal"
            },
            {
              "name": "p_protein_goal"
            },
            {
              "name": "p_carbs_goal"
            },
            {
              "name": "p_fat_goal"
            },
            {
              "name": "p_fiber_goal"
            },
            {
              "name": "p_water_goal_ml"
            },
            {
              "name": "p_timezone"
            }
          ]
        },
        "optimizeResponse": null
      },
      "id": "tool-update-onboarding-001",
      "name": "Update User Onboarding",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        3824,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "DYpIGQK8a652aosj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot{{ env.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $node[\"Telegram Trigger\"].json.message.chat.id, text: $node[\"Strip Signature\"].json.output || $node[\"Simple Reply\"].json.output, reply_markup: { keyboard: [[{ text: \"‚û°Ô∏è –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ\" }]], resize_keyboard: true, one_time_keyboard: false } }) }}",
        "options": {}
      },
      "id": "http-send-keyboard-001",
      "name": "Send Keyboard (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2176,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst telegramUserId = input.telegram_user_id;\n\nif (!telegramUserId) {\n  throw new Error('[WEEK CALCULATIONS] telegram_user_id not found in input');\n}\n\n// Supabase configuration\nconst supabaseUrl = 'https://qyemyvplvtzpukvktkae.supabase.co';\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5ZW15dnBsdnR6cHVrdmt0a2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTk3MzAsImV4cCI6MjA3NTg5NTczMH0.Dn33ZmQFYccuGNAAbjTe6ILDvSQlO45yanNpNvaCUrw';\n\n// Calculate last 7 days (including today)\nconst dates = [];\nconst today = new Date();\nfor (let i = 6; i >= 0; i--) {\n  const date = new Date(today);\n  date.setDate(date.getDate() - i);\n  dates.push(date.toISOString().split('T')[0]);\n}\n\nconsole.log('[WEEK CALCULATIONS] Fetching data for dates:', dates);\n\n// Fetch daily summaries for all 7 days\nconst dailyData = [];\nfor (const dateStr of dates) {\n  try {\n    const response = await $helpers.httpRequest({\n      method: 'POST',\n      url: supabaseUrl + '/rest/v1/rpc/get_daily_summary',\n      headers: {\n        'apikey': supabaseKey,\n        'Content-Type': 'application/json',\n        'Authorization': 'Bearer ' + supabaseKey\n      },\n      body: {\n        p_telegram_user_id: telegramUserId,\n        p_date: dateStr\n      }\n    });\n    \n    dailyData.push({\n      date: dateStr,\n      data: response\n    });\n  } catch (error) {\n    console.error('[WEEK CALCULATIONS] Error fetching ' + dateStr + ':', error.message);\n    dailyData.push({\n      date: dateStr,\n      data: {\n        totals: { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 },\n        water: { total_ml: 0 },\n        entries: []\n      }\n    });\n  }\n}\n\n// Aggregate totals\nlet totalEntries = 0;\nlet totalCalories = 0;\nlet totalProtein = 0;\nlet totalCarbs = 0;\nlet totalFat = 0;\nlet totalFiber = 0;\nlet totalWater = 0;\nlet daysWithData = 0;\n\nfor (const day of dailyData) {\n  const entryCount = day.data?.entries?.length || 0;\n  totalEntries += entryCount;\n  \n  if (entryCount > 0) {\n    daysWithData++;\n  }\n  \n  totalCalories += parseFloat(day.data?.totals?.calories) || 0;\n  totalProtein += parseFloat(day.data?.totals?.protein) || 0;\n  totalCarbs += parseFloat(day.data?.totals?.carbs) || 0;\n  totalFat += parseFloat(day.data?.totals?.fat) || 0;\n  totalFiber += parseFloat(day.data?.totals?.fiber) || 0;\n  totalWater += parseFloat(day.data?.water?.total_ml) || 0;\n}\n\n// Calculate averages (per day)\nconst avgCalories = Math.round(totalCalories / 7);\nconst avgProtein = Math.round(totalProtein / 7);\nconst avgCarbs = Math.round(totalCarbs / 7);\nconst avgFat = Math.round(totalFat / 7);\nconst avgFiber = Math.round(totalFiber / 7);\nconst avgWater = Math.round(totalWater / 7);\n\n// Return structured data for AI Agent\nreturn [{\n  json: {\n    weekStats: {\n      date_range: {\n        start: dates[0],\n        end: dates[6]\n      },\n      totals: {\n        entries: totalEntries,\n        days_with_data: daysWithData,\n        calories: Math.round(totalCalories),\n        protein: Math.round(totalProtein),\n        carbs: Math.round(totalCarbs),\n        fat: Math.round(totalFat),\n        fiber: Math.round(totalFiber),\n        water: Math.round(totalWater)\n      },\n      averages: {\n        calories: avgCalories,\n        protein: avgProtein,\n        carbs: avgCarbs,\n        fat: avgFat,\n        fiber: avgFiber,\n        water: avgWater\n      },\n      daily_breakdown: dailyData.map(d => ({\n        date: d.date,\n        entries: d.data?.entries?.length || 0,\n        calories: Math.round(d.data?.totals?.calories || 0)\n      }))\n    },\n    telegram_user_id: telegramUserId,\n    command: input.command,\n    data: input.data,\n    calculation_source: 'deterministic_code'\n  }\n}];"
      },
      "id": "week-calculations-code-001",
      "name": "Week Calculations Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        -416
      ]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Log Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Message": {
      "main": [
        [
          {
            "node": "Check User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User": {
      "main": [
        [
          {
            "node": "IF Registered",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Registered": {
      "main": [
        [
          {
            "node": "Typing Indicator",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Not Registered",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Typing Indicator": {
      "main": [
        [
          {
            "node": "Prepare Message Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Message Data": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Process Voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Photo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Simple Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Reply": {
      "main": [
        [
          {
            "node": "Route to AI?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Text": {
      "main": [
        [
          {
            "node": "Inject Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Voice": {
      "main": [
        [
          {
            "node": "Download Voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice": {
      "main": [
        [
          {
            "node": "Transcribe Voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Voice": {
      "main": [
        [
          {
            "node": "Merge Voice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Voice Data": {
      "main": [
        [
          {
            "node": "Inject Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Photo": {
      "main": [
        [
          {
            "node": "Download Photo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo": {
      "main": [
        [
          {
            "node": "Extract Barcode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Barcode": {
      "main": [
        [
          {
            "node": "Parse Barcode Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Barcode Result": {
      "main": [
        [
          {
            "node": "IF Has Barcode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Has Barcode": {
      "main": [
        [
          {
            "node": "Get OpenFoodFacts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Restore Binary for Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get OpenFoodFacts": {
      "main": [
        [
          {
            "node": "Parse OpenFoodFacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse OpenFoodFacts": {
      "main": [
        [
          {
            "node": "IF OpenFoodFacts Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF OpenFoodFacts Success": {
      "main": [
        [
          {
            "node": "Merge Photo Paths",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Restore Binary for UPC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Binary for UPC": {
      "main": [
        [
          {
            "node": "Get UPC Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get UPC Database": {
      "main": [
        [
          {
            "node": "Parse UPC Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse UPC Response": {
      "main": [
        [
          {
            "node": "IF UPC Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF UPC Success": {
      "main": [
        [
          {
            "node": "Merge Photo Paths",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Restore Binary for Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Binary for Vision": {
      "main": [
        [
          {
            "node": "Vision Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vision Analysis": {
      "main": [
        [
          {
            "node": "Parse Vision Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Vision Result": {
      "main": [
        [
          {
            "node": "Merge Photo Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Photo Paths": {
      "main": [
        [
          {
            "node": "Inject Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inject Context": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Strip Signature",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Keyboard (HTTP)": {
      "main": [
        [
          {
            "node": "Save AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save AI Response": {
      "main": [
        [
          {
            "node": "Save User Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Sub-workflow Trigger": {
      "main": [
        [
          {
            "node": "Log Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route to AI?": {
      "main": [
        [
          {
            "node": "Week Calculations Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Keyboard (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Conversation Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Save Food Entry": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search Food by Product": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search Similar Entries": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search Today Entries": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Summary": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update User Goal": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete Food Entry": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Log Water Intake": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update User Timezone": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add User Meal": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search User Meals": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update User Meal": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete User Meal": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Monthly Summary": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update User Onboarding": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Week Calculations Code": {
      "main": [
        [
          {
            "node": "Inject Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Strip Signature": {
      "main": [
        [
          {
            "node": "Send Keyboard (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Telegram Trigger": [
      {
        "json": {
          "update_id": 828359048,
          "message": {
            "message_id": 971,
            "from": {
              "id": 682776858,
              "is_bot": false,
              "first_name": "–°–µ—Ä–≥–µ–π",
              "last_name": "–ù–æ–≤–∏–∫–æ–≤",
              "username": "seno1885",
              "language_code": "ru"
            },
            "chat": {
              "id": 682776858,
              "first_name": "–°–µ—Ä–≥–µ–π",
              "last_name": "–ù–æ–≤–∏–∫–æ–≤",
              "username": "seno1885",
              "type": "private"
            },
            "date": 1765834988,
            "text": "/settings",
            "entities": [
              {
                "offset": 0,
                "length": 9,
                "type": "bot_command"
              }
            ]
          }
        }
      }
    ]
  },
  "versionId": "00fedb66-8a87-46a2-939c-7536aea2d94a",
  "activeVersionId": "00fedb66-8a87-46a2-939c-7536aea2d94a",
  "versionCounter": 924,
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-06T19:26:48.330Z",
      "createdAt": "2025-11-06T19:26:48.330Z",
      "role": "workflow:owner",
      "workflowId": "sw3Qs3Fe3JahEbbW",
      "projectId": "a4we7RhtlkIVpqkR",
      "project": {
        "updatedAt": "2025-10-16T17:05:15.692Z",
        "createdAt": "2025-10-16T17:03:54.633Z",
        "id": "a4we7RhtlkIVpqkR",
        "name": "Sergey Novikov <360aya25@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-10-16T17:03:54.633Z",
            "createdAt": "2025-10-16T17:03:54.633Z",
            "userId": "ce467fe1-138e-46ea-871a-373796fc5618",
            "projectId": "a4we7RhtlkIVpqkR",
            "user": {
              "updatedAt": "2025-12-22T23:28:41.000Z",
              "createdAt": "2025-10-16T17:03:54.276Z",
              "id": "ce467fe1-138e-46ea-871a-373796fc5618",
              "email": "360aya25@gmail.com",
              "firstName": "Sergey",
              "lastName": "Novikov",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-10-16T17:05:49.413Z",
                "personalization_survey_n8n_version": "1.115.3",
                "companySize": "<20",
                "companyType": "saas",
                "role": "business-owner",
                "reportedSource": "youtube"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "dutoyHDShhg4TTWY",
                "userActivatedAt": 1760638131717,
                "easyAIWorkflowOnboarded": true,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1760907138361
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-12-22",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": {
    "updatedAt": "2025-12-23T02:31:36.993Z",
    "createdAt": "2025-12-23T02:31:36.993Z",
    "versionId": "00fedb66-8a87-46a2-939c-7536aea2d94a",
    "workflowId": "sw3Qs3Fe3JahEbbW",
    "nodes": [
      {
        "parameters": {
          "updates": [
            "message"
          ],
          "additionalFields": {}
        },
        "id": "454ac29e-dce6-43f0-82cf-2304cc20545f",
        "name": "Telegram Trigger",
        "type": "n8n-nodes-base.telegramTrigger",
        "typeVersion": 1.2,
        "position": [
          -1136,
          128
        ],
        "webhookId": "1bf5d250-c832-495e-992f-12d2bf57dfbd",
        "credentials": {
          "telegramApi": {
            "id": "ofhXzaw3ObXDT5JY",
            "name": "Multi_Bot0101_bot"
          }
        }
      },
      {
        "parameters": {
          "tableId": "message_processing_log",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "message_id",
                "fieldValue": "={{ $json.message.message_id }}"
              },
              {
                "fieldId": "telegram_user_id",
                "fieldValue": "={{ $json.message.from.id }}"
              }
            ]
          }
        },
        "id": "98883f54-610b-485a-a45b-83b7bfd88a8f",
        "name": "Log Message",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -976,
          128
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        },
        "continueOnFail": true
      },
      {
        "parameters": {
          "operation": "get",
          "tableId": "users",
          "filters": {
            "conditions": [
              {
                "keyName": "telegram_user_id",
                "keyValue": "={{ $node[\"Telegram Trigger\"].json.message.from.id }}"
              }
            ]
          }
        },
        "id": "90b986bb-f244-4a25-9d55-a3f2baa451bf",
        "name": "Check User",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          -800,
          128
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "condition1",
                "leftValue": "={{ $json.id }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "04a22337-2efe-48c2-9a4f-b70b9dc6072e",
        "name": "IF Registered",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -640,
          128
        ]
      },
      {
        "parameters": {
          "chatId": "={{ $node[\"Telegram Trigger\"].json.message.chat.id }}",
          "text": "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è: https://t.me/Multi_Bot0101_bot?start=register",
          "additionalFields": {
            "appendAttribution": false
          }
        },
        "id": "0dc205e8-dff5-48f9-9f75-29540fa3910f",
        "name": "Not Registered",
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          -624,
          512
        ],
        "webhookId": "3ef5eafe-411b-4eb2-9a8c-da4e142819b2",
        "credentials": {
          "telegramApi": {
            "id": "ofhXzaw3ObXDT5JY",
            "name": "Multi_Bot0101_bot"
          }
        }
      },
      {
        "parameters": {
          "operation": "sendChatAction",
          "chatId": "={{ $node[\"Telegram Trigger\"].json.message.chat.id }}"
        },
        "id": "0538def8-e810-40ec-949e-22cda344d2a7",
        "name": "Typing Indicator",
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          -528,
          -16
        ],
        "webhookId": "7a38b2bd-6d17-42c5-9bee-5778a2e75918",
        "credentials": {
          "telegramApi": {
            "id": "ofhXzaw3ObXDT5JY",
            "name": "Multi_Bot0101_bot"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "restore-message",
                "name": "message",
                "value": "={{ $node[\"Telegram Trigger\"].json.message }}",
                "type": "object"
              },
              {
                "id": "add-user-data",
                "name": "user",
                "value": "={{ $node[\"Check User\"].json }}",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "id": "prepare-message-data-001",
        "name": "Prepare Message Data",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -400,
          -16
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "voice-check",
                      "leftValue": "={{ $json.message.voice }}",
                      "operator": {
                        "type": "object",
                        "operation": "notEmpty"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "voice"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "photo-check",
                      "leftValue": "={{ $json.message.photo }}",
                      "operator": {
                        "type": "array",
                        "operation": "notEmpty"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "photo"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "/start",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "5583f843-611a-4021-a689-c24f16f9d03b"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "start_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "/help",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "fb4f5625-196d-4956-8dc6-527a5f6d5a06"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "help_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "/report|/day",
                      "operator": {
                        "type": "string",
                        "operation": "regex"
                      },
                      "id": "ebf5ef39-5c17-4b2f-9f3a-630310505d3c"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "day_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "/stats|/week",
                      "operator": {
                        "type": "string",
                        "operation": "regex"
                      },
                      "id": "952b2008-7b5f-4aae-8147-5b3815e6a8d9"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "week_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "/settings",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "388517b7-ddca-44ad-8333-96466ea9e6a8"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "settings_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "/restart",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "19fc2605-705f-4733-8058-f069b5257a1f"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "restart_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "^/welcome",
                      "operator": {
                        "type": "string",
                        "operation": "regex"
                      },
                      "id": "fed012c1-9bce-4c31-9670-fd124562a3f9"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "welcome_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "rightValue": "^/month",
                      "operator": {
                        "type": "string",
                        "operation": "regex"
                      },
                      "id": "7f2eecd5-300d-40d0-aa8a-a3d9a85bed7e"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "month_command"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.message.text }}",
                      "operator": {
                        "type": "string",
                        "operation": "exists"
                      },
                      "id": "75e7b4e4-e127-4ec7-9bfb-1351ba3d9990"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "text"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -288,
          128
        ],
        "id": "52133fd5-62ec-4aaa-a265-c225274c6c16",
        "name": "Switch"
      },
      {
        "parameters": {
          "jsCode": "const input = $input.first().json;\nconst message = input.message;\nconst user = input.user;\n\nif (!user || !user.telegram_user_id) {\n  throw new Error(\"User data not found in execution context\");\n}\n\nreturn [{ \n  type: 'text', \n  data: message.text, \n  telegram_user_id: user.telegram_user_id, \n  user_id: user.id, \n  owner: user.owner \n}];"
        },
        "id": "009e557b-b9d5-4087-bedd-0736f1b04544",
        "name": "Process Text",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          272,
          -32
        ]
      },
      {
        "parameters": {
          "jsCode": "const input = $input.first().json;\nconst message = input.message;\nconst user = input.user;\n\nif (!user || !user.id) {\n  throw new Error(\"User data not found in execution context\");\n}\n\nreturn [{\n  type: 'voice',\n  voice_file_id: message.voice.file_id,\n  message: message,\n  user_id: user.id,\n  telegram_user_id: user.telegram_user_id,\n  owner: user.owner\n}];"
        },
        "id": "04f2c478-b7d9-4b36-b3bb-1ee97e60fed9",
        "name": "Process Voice",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          0,
          144
        ]
      },
      {
        "parameters": {
          "resource": "file",
          "fileId": "={{ $json.voice_file_id }}",
          "additionalFields": {}
        },
        "id": "f0320ed4-3e52-4346-881a-2316b7af6ae2",
        "name": "Download Voice",
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          192,
          144
        ],
        "webhookId": "d5682e09-d29e-47d0-9c65-552ec9dea4ca",
        "credentials": {
          "telegramApi": {
            "id": "ofhXzaw3ObXDT5JY",
            "name": "Multi_Bot0101_bot"
          }
        }
      },
      {
        "parameters": {
          "resource": "audio",
          "operation": "transcribe",
          "options": {}
        },
        "id": "8eea1509-2f8a-45f4-ba73-cece0e9b43ab",
        "name": "Transcribe Voice",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.8,
        "position": [
          400,
          144
        ],
        "credentials": {
          "openAiApi": {
            "id": "NPHTuT9Bime92Mku",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const transcription = $json.text;\nconst voiceData = $(\"Process Voice\").first().json;\nreturn [{\n  type: 'voice',\n  data: transcription,\n  user_id: voiceData.user_id,\n  telegram_user_id: voiceData.telegram_user_id,\n  owner: voiceData.owner\n}];"
        },
        "id": "232b4bc6-e052-4570-b15a-f6300e09a7d5",
        "name": "Merge Voice Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          592,
          144
        ]
      },
      {
        "parameters": {
          "jsCode": "const input = $input.first().json;\nconst message = input.message;\nconst user = input.user;\n\nif (!user || !user.id) {\n  throw new Error(\"User data not found in execution context\");\n}\n\nconst photos = message.photo;\nconst largestPhoto = photos[photos.length - 1];\nreturn [{ \n  type: 'photo', \n  photo_file_id: largestPhoto.file_id, \n  message: message, \n  user_id: user.id, \n  telegram_user_id: user.telegram_user_id, \n  owner: user.owner \n}];"
        },
        "id": "bcac5096-0cc4-42ce-93bd-4fb471ed67d9",
        "name": "Process Photo",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          0,
          288
        ]
      },
      {
        "parameters": {
          "resource": "file",
          "fileId": "={{ $json.photo_file_id }}",
          "additionalFields": {}
        },
        "id": "d8ce2c0b-9fb4-4579-98a7-581481e29c30",
        "name": "Download Photo",
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          192,
          288
        ],
        "webhookId": "82c56e64-5ae0-4ee6-93b0-b7811539f5b9",
        "credentials": {
          "telegramApi": {
            "id": "ofhXzaw3ObXDT5JY",
            "name": "Multi_Bot0101_bot"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "barcode-check",
                "leftValue": "={{ $json.has_barcode }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "a05b15c1-7b84-4eb7-895a-ec9a28219b69",
        "name": "IF Has Barcode",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          240,
          608
        ]
      },
      {
        "parameters": {
          "jsCode": "const downloadedPhoto = $(\"Download Photo\").first();\nconst currentData = $input.first().json;\n\nreturn [{\n  json: {\n    ...currentData,\n    telegram_user_id: currentData.telegram_user_id\n  },\n  binary: downloadedPhoto.binary\n}];"
        },
        "id": "restore-binary-vision-001",
        "name": "Restore Binary for Vision",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          496,
          656
        ]
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4o-mini"
          },
          "text": "Analyze this food photo. Identify the food items visible and estimate their quantities. Return in format: 'food_name: quantity unit'",
          "inputType": "base64",
          "options": {}
        },
        "id": "9364c869-f156-4214-810d-0a680db5e188",
        "name": "Vision Analysis",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.8,
        "position": [
          672,
          656
        ],
        "credentials": {
          "openAiApi": {
            "id": "NPHTuT9Bime92Mku",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {},
        "id": "ad709023-1205-4d27-8414-41e0590318d5",
        "name": "Merge Photo Paths",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          1008,
          672
        ]
      },
      {
        "parameters": {
          "jsCode": "const visionResult = $json.content || $json.text || $json.response || $json.output;\nconst photoData = $(\"Process Photo\").first().json;\n\nreturn [{\n  type: 'photo',\n  data: visionResult,\n  source: 'vision',\n  user_id: photoData.user_id,\n  telegram_user_id: photoData.telegram_user_id,\n  owner: photoData.owner\n}];"
        },
        "id": "4c26424a-a4da-40e2-8fba-0555f1356ddb",
        "name": "Parse Vision Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          816,
          656
        ]
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4o-mini"
          },
          "text": "Look carefully at this product image for a barcode or EAN/UPC number. If you find a barcode, return ONLY the numeric code (no text, no explanation). If no barcode is visible or readable, return exactly: NO_BARCODE",
          "inputType": "base64",
          "options": {}
        },
        "id": "e23b98c5-c49d-4d11-83e4-3ee2dab350c3",
        "name": "Extract Barcode",
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.8,
        "position": [
          400,
          288
        ],
        "credentials": {
          "openAiApi": {
            "id": "NPHTuT9Bime92Mku",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const visionResponse = $json.content || $json.text || '';\nconst photoData = $(\"Process Photo\").first().json;\n\nconst barcodeMatch = visionResponse.match(/\\d{8,14}/);\nconst hasBarcode = barcodeMatch && visionResponse !== 'NO_BARCODE';\n\nreturn [{\n  json: {\n    barcode: hasBarcode ? barcodeMatch[0] : null,\n    has_barcode: hasBarcode,\n    user_id: photoData.user_id,\n    telegram_user_id: photoData.telegram_user_id,\n    owner: photoData.owner,\n    vision_response: visionResponse\n  },\n  binary: $input.item.binary\n}];"
        },
        "id": "7d0dc95a-b5cf-47e9-9945-b72fc691b490",
        "name": "Parse Barcode Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          592,
          320
        ]
      },
      {
        "parameters": {
          "url": "=https://world.openfoodfacts.org/api/v2/product/{{ $json.barcode }}.json",
          "options": {}
        },
        "id": "3eb4fa16-23f0-4e33-b6b9-509d315ba719",
        "name": "Get OpenFoodFacts",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          496,
          528
        ],
        "continueOnFail": true
      },
      {
        "parameters": {
          "jsCode": "const offResponse = $input.first().json;\nconst photoData = $(\"Process Photo\").first().json;\n\nif (offResponse.error || offResponse.status === 0) {\n  return [{\n    json: {\n      success: false,\n      source: 'openfoodfacts',\n      error: offResponse.error || 'Product not found in OpenFoodFacts',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nif (!offResponse.product || offResponse.status !== 1) {\n  return [{\n    json: {\n      success: false,\n      source: 'openfoodfacts',\n      error: 'Product not found in OpenFoodFacts database',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: offResponse.code || $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nconst product = offResponse.product;\nconst productName = product.product_name || product.product_name_ru || product.product_name_en || 'Unknown Product';\nconst brand = product.brands || 'Unknown Brand';\n\nreturn [{\n  json: {\n    type: 'photo',\n    source: 'openfoodfacts',\n    success: true,\n    data: `${brand} - ${productName}`,\n    product_name: productName,\n    brand: brand,\n    barcode: product.code || offResponse.code,\n    calories: product.nutriments?.['energy-kcal_100g'] || 0,\n    protein: product.nutriments?.proteins_100g || 0,\n    carbs: product.nutriments?.carbohydrates_100g || 0,\n    fat: product.nutriments?.fat_100g || 0,\n    user_id: photoData.user_id,\n    telegram_user_id: photoData.telegram_user_id,\n    owner: photoData.owner,\n    raw_off_response: offResponse\n  },\n  binary: $input.item.binary\n}];"
        },
        "id": "f4b72600-dcaf-41d1-bc46-039e2e0a0739",
        "name": "Parse OpenFoodFacts",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          672,
          512
        ]
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4o-mini"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          1376,
          688
        ],
        "id": "18d2242f-51eb-48c9-8d1c-1fef81ce9974",
        "name": "OpenAI Chat Model",
        "credentials": {
          "openAiApi": {
            "id": "NPHTuT9Bime92Mku",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Save a food entry to the database.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_food_entry",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_food_item"
              },
              {
                "name": "p_quantity"
              },
              {
                "name": "p_unit"
              },
              {
                "name": "p_calories"
              },
              {
                "name": "p_protein"
              },
              {
                "name": "p_carbs"
              },
              {
                "name": "p_fats"
              },
              {
                "name": "p_fiber",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_date"
              },
              {
                "name": "p_time",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID number",
                "type": "number"
              },
              {
                "name": "p_food_item",
                "description": "Food name in Russian",
                "type": "string"
              },
              {
                "name": "p_quantity",
                "description": "Quantity as number",
                "type": "number"
              },
              {
                "name": "p_unit",
                "description": "Unit: grams, ml, or pcs",
                "type": "string"
              },
              {
                "name": "p_calories",
                "description": "Calories as number",
                "type": "number"
              },
              {
                "name": "p_protein",
                "description": "Protein in grams",
                "type": "number"
              },
              {
                "name": "p_carbs",
                "description": "Carbs in grams",
                "type": "number"
              },
              {
                "name": "p_fats",
                "description": "Fats in grams",
                "type": "number"
              },
              {
                "name": "p_fiber",
                "description": "Fiber in grams (optional)",
                "type": ""
              },
              {
                "name": "p_date",
                "description": "Date in YYYY-MM-DD format",
                "type": "string"
              },
              {
                "name": "p_time",
                "description": "Time in HH:MM format (optional)",
                "type": ""
              }
            ]
          }
        },
        "id": "cccfae9d-4439-438c-9471-baf194b83445",
        "name": "Save Food Entry",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          2432,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Check User').first().json.telegram_user_id }}",
          "contextWindowLength": 10
        },
        "id": "memory-buffer-node-001",
        "name": "Conversation Memory",
        "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
        "typeVersion": 1.3,
        "position": [
          1520,
          688
        ],
        "credentials": {
          "postgres": {
            "id": "YfW5ar1A5pmUD0If",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "options": {
            "systemMessage": "## CRITICAL: SESSION DETECTION LOGIC\n\n**How to detect if you're in a session:**\n\n1. **Check conversation history** - Did user start with `/welcome`, `/settings`, or `/meals`?\n2. **Check input context** - Is there a `session_mode` field?\n3. **Apply session-specific rules** (see below)\n\n**General rules for ALL sessions:**\n- ‚úÖ **ALWAYS** use `telegram_user_id` from input context (NEVER null!)\n- ‚úÖ **REMEMBER** everything from THIS CURRENT conversation\n- ‚ùå **IGNORE** previous attempts of SAME command from conversation history\n\n---\n\n## ‚ö†Ô∏è CRITICAL: RESPONSE STYLE (MANDATORY!)\n\n- Friendly Russian tone\n- **MANDATORY emojis in EVERY response:** üìäü•©üçûüßàüåæüíß\n- Concise (2-3 sentences max)\n- Macro format: \"–ë–µ–ª–∫–∏: XX–≥ ü•© | –£–≥–ª–µ–≤–æ–¥—ã: XX–≥ üçû | –ñ–∏—Ä—ã: XX–≥ üßà | –ö–∞–ª–æ—Ä–∏–∏: XX–∫–∫–∞–ª üìä | –ö–ª–µ—Ç—á–∞—Ç–∫–∞: XX–≥ üåæ | –í–æ–¥–∞: XXX–º–ª üíß\"\n\n---\n\n## SESSION TYPE: /welcome\n\n**Detection:**\n- User sent `/welcome` command, OR\n- Input context has `session_mode: \"/welcome\"`, OR\n- Conversation history shows you asked onboarding questions\n\n**Rules during /welcome:**\n- ‚úÖ **USE** `telegram_user_id` from input context (required for database!)\n- ‚ùå **IGNORE** `user_goals` and `user_profile` from input context (OLD data from previous onboarding!)\n- ‚úÖ **REMEMBER** all 12 answers from THIS CURRENT conversation (6 profile + 6 macros)\n- ‚ùå **IGNORE** previous /welcome sessions from conversation history (old attempts)\n\n**Why:** User is updating their ENTIRE profile. Old database values would confuse you about what data to save.\n\n**Example flow:**\n```\nUser: /welcome\nYou: \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\nUser: \"–°–µ—Ä–≥–µ–π\"\nYou remember: name = \"–°–µ—Ä–≥–µ–π\" ‚úÖ\n\n[... 11 more questions ...]\n\nYou show confirmation with ALL 12 values from THIS conversation\nUser: \"–¥–∞\"\n\nTool call: {\n  p_telegram_user_id: 682776858,  ‚Üê from input context ‚úÖ\n  p_name: \"–°–µ—Ä–≥–µ–π\",                ‚Üê from THIS conversation ‚úÖ\n  p_age: 87,                        ‚Üê from THIS conversation ‚úÖ\n  ... (all from THIS conversation, NOT from input context!)\n}\n```\n\n---\n\n## SESSION TYPE: /settings\n\n**What can be changed:**\n- Goal (weight_loss / maintenance / muscle_gain)\n- Weight (kg)\n- Timezone (IANA format)\n- Macro goals (calories, protein, carbs, fat, fiber, water)\n\n**Detection:**\n- User sent `/settings` command, OR\n- Input context has `session_mode: \"/settings\"`, OR\n- User asked to change specific settings\n\n**Rules during /settings:**\n- ‚úÖ **USE** `telegram_user_id` from input context\n- üî¥ **CRITICAL:** READ `user_goals` and `user_profile` from INPUT CONTEXT and SHOW real values to user!\n- ‚úÖ **SHOW** current values from ALL settings: goal, weight, timezone, macros (so user knows what to change)\n- ‚ùå **DO NOT** use placeholders like [Your Goal] - use REAL values from input context!\n- ‚úÖ **REMEMBER** what user wants to CHANGE from THIS conversation\n- ‚ö†Ô∏è **UPDATE** only changed fields, keep everything else from database\n- üìä **CRITICAL:** ALWAYS use emojis in output! (see Response Style section)\n- üá∑üá∫ **CRITICAL:** ALWAYS respond in RUSSIAN, NEVER in English!\n\n**Why:** User is changing 1-2 fields. You need to show CURRENT state, but only update what they explicitly change.\n\n**Example flow:**\n```\nUser: /settings\nInput context: {user_goals: {protein: 140, carbs: 246, ...}, user_profile: {goal: \"weight_loss\", timezone: \"Europe/Moscow\", name: \"–°–µ—Ä–≥–µ–π\", age: 66, height_cm: 188, weight_kg: 98, ...}}\n\nYou: \"–í–æ—Ç —Ç–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n\n1. –ò–º—è: –°–µ—Ä–≥–µ–π\n2. –í–æ–∑—Ä–∞—Å—Ç: 66 –ª–µ—Ç\n3. –†–æ—Å—Ç: 188 —Å–º\n4. –í–µ—Å: 98 –∫–≥\n5. –¶–µ–ª—å: –ø–æ—Ö—É–¥–µ–Ω–∏–µ\n6. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Europe/Moscow\n7. –ö–∞–ª–æ—Ä–∏–∏: 110 –∫–∫–∞–ª üìä\n8. –ë–µ–ª–∫–∏: 122–≥ ü•©\n9. –£–≥–ª–µ–≤–æ–¥—ã: 24–≥ üçû\n10. –ñ–∏—Ä—ã: 34–≥ üßà\n11. –ö–ª–µ—Ç—á–∞—Ç–∫–∞: 54–≥ üåæ\n12. –í–æ–¥–∞: 2100–º–ª üíß\n\n–ß—Ç–æ —Ö–æ—á–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å?\"\n\nUser: \"—Ö–æ—á—É –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã\"\nYou remember: user wants to change GOAL to \"muscle_gain\" ‚úÖ\n\nTool call: Update User Goal {\n  p_telegram_user_id: 682776858,  ‚Üê from input context ‚úÖ\n  p_goal: \"muscle_gain\"           ‚Üê from THIS conversation ‚úÖ\n}\n```\n\n---\n\n## SESSION TYPE: /meals\n\n**Detection:**\n- User sent `/meals` command, OR\n- Input context has `session_mode: \"/meals\"`, OR\n- User is adding/editing/deleting meal templates\n\n**Rules during /meals:**\n- ‚úÖ **USE** `telegram_user_id` from input context\n- ‚úÖ **REMEMBER** meal data collected from THIS conversation (name, ingredients, macros)\n- Use appropriate tools: Add User Meal, Update User Meal, Delete User Meal, Search User Meals\n\n**Why:** User is creating/editing custom meal templates. Need to collect multiple fields through dialog.\n\n**Example flow:**\n```\nUser: /meals\nYou: \"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –±–ª—é–¥. –ö–æ–º–∞–Ω–¥—ã: –¥–æ–±–∞–≤–∏—Ç—å/–Ω–∞–π—Ç–∏/–∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å\"\n\nUser: \"–¥–æ–±–∞–≤–∏—Ç—å –æ–º–ª–µ—Ç\"\nYou: \"–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ —Ç–≤–æ–µ–º –æ–º–ª–µ—Ç–µ?\"\nYou remember: meal_name = \"–æ–º–ª–µ—Ç\" ‚úÖ\n\nUser: \"3 —è–π—Ü–∞, 50–º–ª –º–æ–ª–æ–∫–∞\"\nYou remember: ingredients = \"3 —è–π—Ü–∞, 50–º–ª –º–æ–ª–æ–∫–∞\" ‚úÖ\n\nTool call: Add User Meal {\n  p_telegram_user_id: 682776858,     ‚Üê from input context ‚úÖ\n  p_meal_name: \"–æ–º–ª–µ—Ç\",              ‚Üê from THIS conversation ‚úÖ\n  p_ingredients: \"3 —è–π—Ü–∞, 50–º–ª –º–æ–ª–æ–∫–æ\" ‚Üê from THIS conversation ‚úÖ\n}\n```\n\n---\n\n## NORMAL MODE (no session)\n\n**When:** User sends regular messages (food logs, questions, reports)\n\n**Rules:**\n- ‚úÖ **USE** full context from input: `telegram_user_id`, `user_goals`, `user_profile`, `user_name`\n- ‚úÖ **USE** conversation history normally\n- Use tools as needed for food logging, reports, etc.\n\n---\n\n## Role Definition\n\nYou are a helpful AI nutrition coach for a food tracking Telegram bot.\nYou help users track meals, calculate macros, set goals, and manage nutrition.\n\n---\n\n## Available Tools (15):\n\n### Food Management:\n1. **Save Food Entry** - Log food (p_telegram_user_id, p_product_name, p_quantity_g, p_protein, p_carbs, p_fat, p_calories, p_fiber?, p_time?)\n2. **Search Food by Product** - Find entries (p_telegram_user_id, p_product_name)\n3. **Search Similar Entries** - Similar foods (p_telegram_user_id, p_product_name)\n4. **Search Today Entries** - Today's log (p_telegram_user_id)\n5. **Delete Food Entry** - Remove entry (p_telegram_user_id, p_entry_id)\n\n### Reports:\n6. **Get Daily Summary** - Daily report (p_telegram_user_id, p_date)\n7. **Get Monthly Summary** - Monthly report (p_telegram_user_id, p_year_month)\n\n### Settings:\n8. **Update User Goal** - Change goal (p_telegram_user_id, p_goal: \"weight_loss\"/\"maintenance\"/\"muscle_gain\")\n9. **Update User Timezone** - Change timezone (p_telegram_user_id, p_timezone: IANA format)\n10. **Update User Onboarding** - Complete onboarding (13 params - see /welcome section, includes user-provided calories_goal)\n\n### Meal Planning:\n11. **Add User Meal** - Create template (p_telegram_user_id, p_meal_name, p_ingredients)\n12. **Search User Meals** - Find templates (p_telegram_user_id, p_search_term?)\n13. **Update User Meal** - Edit template (p_telegram_user_id, p_meal_id, p_meal_name?, p_ingredients?)\n14. **Delete User Meal** - Remove template (p_telegram_user_id, p_meal_id)\n\n### Water:\n15. **Log Water Intake** - Track water (p_telegram_user_id, p_amount_ml, p_time?)\n\n---\n\n## /welcome Command Details\n\n**MANDATORY CHECKLIST before calling Update User Onboarding:**\n- [ ] Asked ALL 6 profile questions (a-f)\n- [ ] Asked ALL 6 macro questions (g-l)\n- [ ] Converted timezone to IANA format\n- [ ] Have `telegram_user_id` from input context\n\n**Question Sequence (ONE BY ONE):**\n\n**Profile (6):**\na) \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\" ‚Üí name\nb) \"–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?\" ‚Üí age\nc) **[MANDATORY!]** \"–ö–∞–∫–æ–π —É —Ç–µ–±—è —Ä–æ—Å—Ç –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö?\" ‚Üí height_cm\nd) \"–°–∫–æ–ª—å–∫–æ —Ç—ã –≤–µ—Å–∏—à—å? (–≤ –∫–≥)\" ‚Üí weight_kg\ne) \"–ö–∞–∫–∞—è —É —Ç–µ–±—è —Ü–µ–ª—å?\" (–ø–æ—Ö—É–¥–µ–Ω–∏–µ/–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ/–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã) ‚Üí goal\nf) \"–í –∫–∞–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ?\" ‚Üí timezone\n\n**Macros (6):**\ng) –ö–∞–ª–æ—Ä–∏–∏ ‚Üí calories_goal\nh) –ë–µ–ª–∫–∏ ‚Üí protein_goal\ni) –£–≥–ª–µ–≤–æ–¥—ã ‚Üí carbs_goal\nj) –ñ–∏—Ä—ã ‚Üí fat_goal\nk) –ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üí fiber_goal\nl) –í–æ–¥–∞ (–º–ª) ‚Üí water_goal_ml\n\n**Timezone Conversion:**\n- –ú–æ–Ω—Ä–µ–∞–ª—å ‚Üí America/Toronto\n- –ú–æ—Å–∫–≤–∞ ‚Üí Europe/Moscow\n- –ö–∏–µ–≤ ‚Üí Europe/Kiev\n\n**Macro Calculation (optional offer - but ALWAYS ask user for final values):**\n‚ö†Ô∏è **CRITICAL:** You can OFFER to calculate macros, but MUST ask user for FINAL values. NO auto-calculation in database!\n\n**Suggested formulas (offer, but let user decide):**\n- Calories: weight √ó 22/27/32 (loss/maintain/gain) - **ASK user for their target!**\n- Protein: weight √ó 1.6 (or √ó2.0 for muscle_gain)\n- Carbs: (calories √ó 0.50) / 4\n- Fat: (calories √ó 0.25) / 9\n- Fiber: 25-30g\n- Water: weight √ó 30ml (min 2000)\n\n**Example dialog:**\n\"–î–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é 1430 –∫–∫–∞–ª (65–∫–≥ √ó 22). –°–æ–≥–ª–∞—Å–µ–Ω –∏–ª–∏ —Ö–æ—á–µ—à—å –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ?\"\nUser: \"1430 –Ω–æ—Ä–º\" ‚Üê Save 1430 to database\n\n**MANDATORY CONFIRMATION FORMAT:**\n```\n–û—Ç–ª–∏—á–Ω–æ, [name]! –ü—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ:\n1. –ò–º—è: [name]\n2. –í–æ–∑—Ä–∞—Å—Ç: [age]\n3. –†–æ—Å—Ç: [height] —Å–º\n4. –í–µ—Å: [weight] –∫–≥\n5. –¶–µ–ª—å: [goal_ru]\n6. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: [timezone]\n7. –ö–∞–ª–æ—Ä–∏–∏: [calories] –∫–∫–∞–ª üìä\n8. –ë–µ–ª–∫–∏: [protein]–≥ ü•©\n9. –£–≥–ª–µ–≤–æ–¥—ã: [carbs]–≥ üçû\n10. –ñ–∏—Ä—ã: [fat]–≥ üßà\n11. –ö–ª–µ—Ç—á–∞—Ç–∫–∞: [fiber]–≥ üåæ\n12. –í–æ–¥–∞: [water]–º–ª üíß\n\n–í—Å–µ –≤–µ—Ä–Ω–æ?\n```\n\n**After saving:** \"‚úÖ –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\"\n\n---\n\n## Error Handling\n\n- If tool returns error ‚Üí explain simply in Russian\n- Suggest alternative actions\n- Never expose technical details to user\n\n---\n\n## Important Notes\n\n- **p_telegram_user_id:** ALWAYS from input context, NEVER null!\n- Tool parameters use `p_` prefix\n- Optional params (p_fiber, p_time): pass null if not provided\n- Timezone MUST be IANA format\n- Height (height_cm) is MANDATORY in /welcome\n"
          }
        },
        "id": "cdfe74df-5815-4557-bf8f-f0213d9ca8ad",
        "name": "AI Agent",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 2.2,
        "position": [
          1456,
          352
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "version": 2,
              "leftValue": "",
              "caseSensitive": true,
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "openfoodfacts-success-check",
                "leftValue": "={{ $json.success }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "if-openfoodfacts-success-001",
        "name": "IF OpenFoodFacts Success",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1008,
          496
        ]
      },
      {
        "parameters": {
          "jsCode": "const downloadedPhoto = $(\"Download Photo\").first();\nconst currentData = $input.first().json;\n\nreturn [{\n  json: {\n    ...currentData,\n    barcode: currentData.barcode,\n    user_id: currentData.user_id,\n    telegram_user_id: currentData.telegram_user_id\n  },\n  binary: downloadedPhoto.binary\n}];"
        },
        "id": "restore-binary-upc-001",
        "name": "Restore Binary for UPC",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1104,
          960
        ]
      },
      {
        "parameters": {
          "url": "=https://api.upcitemdb.com/prod/trial/lookup?upc={{ $json.barcode }}",
          "options": {}
        },
        "id": "get-upc-database-001",
        "name": "Get UPC Database",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1280,
          960
        ],
        "continueOnFail": true
      },
      {
        "parameters": {
          "jsCode": "const upcResponse = $input.first().json;\nconst photoData = $(\"Process Photo\").first().json;\n\nif (upcResponse.error || upcResponse.code === 'INVALID_UPC') {\n  return [{\n    json: {\n      success: false,\n      source: 'upc_database',\n      error: upcResponse.error || 'Product not found in UPC database',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nif (upcResponse.code === 'RATE_LIMIT_EXCEEDED') {\n  return [{\n    json: {\n      success: false,\n      source: 'upc_database',\n      error: 'UPC Database rate limit exceeded (100/day)',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nconst item = upcResponse.items?.[0];\nif (!item) {\n  return [{\n    json: {\n      success: false,\n      source: 'upc_database',\n      error: 'Empty response from UPC database',\n      user_id: photoData.user_id,\n      telegram_user_id: photoData.telegram_user_id,\n      owner: photoData.owner,\n      barcode: $(\"Parse Barcode Result\").first().json.barcode\n    },\n    binary: $input.item.binary\n  }];\n}\n\nconst rawBarcode = $(\"Parse Barcode Result\").first().json.barcode;\nconst upcBarcode = (rawBarcode.startsWith('0') && rawBarcode.length === 13) ? rawBarcode.substring(1) : rawBarcode;\n\nreturn [{\n  json: {\n    type: 'photo',\n    source: 'upc_database',\n    success: true,\n    data: `${item.brand || 'Unknown'} - ${item.title}`,\n    product_name: item.title,\n    brand: item.brand,\n    category: item.category,\n    barcode: upcBarcode,\n    user_id: photoData.user_id,\n    telegram_user_id: photoData.telegram_user_id,\n    owner: photoData.owner,\n    raw_upc_response: upcResponse\n  },\n  binary: $input.item.binary\n}];"
        },
        "id": "parse-upc-response-001",
        "name": "Parse UPC Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1456,
          960
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "version": 2,
              "leftValue": "",
              "caseSensitive": true,
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "upc-success-check",
                "leftValue": "={{ $json.success }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "if-upc-success-001",
        "name": "IF UPC Success",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1616,
          976
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_conversation_message",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ JSON.stringify({ p_user_id: $('Prepare Message Data').first().json.user.id, p_role: 'user', p_content: $('Telegram Trigger').first().json.message.text || $('Telegram Trigger').first().json.message.caption || 'photo/voice message' }) }}",
          "options": {}
        },
        "id": "save-user-message-001",
        "name": "Save User Message",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2592,
          144
        ],
        "credentials": {
          "httpHeaderAuth": {
            "id": "rDcjW0UFczbmWtVq",
            "name": "Supabase Header Auth"
          }
        },
        "disabled": true,
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_conversation_message",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ JSON.stringify({ p_user_id: $('Prepare Message Data').first().json.user.id, p_role: 'assistant', p_content: $('AI Agent').first().json.output || '' }) }}",
          "options": {}
        },
        "id": "save-ai-response-001",
        "name": "Save AI Response",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2384,
          144
        ],
        "credentials": {
          "httpHeaderAuth": {
            "id": "rDcjW0UFczbmWtVq",
            "name": "Supabase Header Auth"
          }
        },
        "disabled": true,
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "jsCode": "// Inject Context with Session State Tracking\n// FIXED: Adds user data INSIDE chatInput so AI Agent can see it\n\n// === CONFIG ===\nconst SUPABASE_URL = 'https://qyemyvplvtzpukvktkae.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5ZW15dnBsdnR6cHVrdmt0a2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3OTQ3MTQsImV4cCI6MjA0ODM3MDcxNH0.SV5u6EIu9k9bBHmI4LObbJqoecFNlgH4v23fwuiLAXY';\n\n// === EXTRACT USER MESSAGE ===\nconst userMessage = $json.data ||               // Process Text (most common!)\n                   $json.command ||             // Week Calculations Code\n                   $json.message?.text ||       // Direct from Telegram Trigger\n                   $json.chatInput ||           // From AI Agent input\n                   $json.transcription ||       // From Voice processing  \n                   $json.product_name ||        // From Photo processing\n                   '';\n\nconst userProfile = $node['Check User'].json;\nconst telegramUserId = userProfile.telegram_user_id;\n\n// === SESSION STATE FUNCTIONS ===\nasync function getSession() {\n  try {\n    const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_user_session`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': SUPABASE_KEY,\n        'Authorization': `Bearer ${SUPABASE_KEY}`\n      },\n      body: JSON.stringify({ p_telegram_user_id: telegramUserId })\n    });\n    return await response.json();\n  } catch (e) {\n    return {};\n  }\n}\n\nasync function startSession(command) {\n  try {\n    await fetch(`${SUPABASE_URL}/rest/v1/rpc/start_user_session`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': SUPABASE_KEY,\n        'Authorization': `Bearer ${SUPABASE_KEY}`\n      },\n      body: JSON.stringify({ p_telegram_user_id: telegramUserId, p_command: command })\n    });\n  } catch (e) {}\n}\n\n// === MAIN LOGIC ===\nconst isCommandStart = userMessage.trim().startsWith('/');\nlet session = await getSession();\n\n// If new command, start new session\nif (isCommandStart) {\n  const command = userMessage.trim().split(' ')[0].toLowerCase();\n  await startSession(command);\n  session = { active_command: command };\n}\n\n// Check if in session mode (e.g., /welcome flow)\nconst inSessionMode = session && session.active_command;\nconst isWelcomeMode = inSessionMode && session.active_command === '/welcome';\n\n// === BUILD CHAT INPUT WITH CONTEXT ===\nlet chatInput = userMessage;\n\n// For /settings and normal mode, ADD user data to chatInput so AI can see it\nif (!isWelcomeMode) {\n  const goalRu = userProfile.goal === 'weight_loss' ? '–ø–æ—Ö—É–¥–µ–Ω–∏–µ' :\n                 userProfile.goal === 'maintenance' ? '–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ' :\n                 userProfile.goal === 'muscle_gain' ? '–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã' : userProfile.goal;\n  \n  chatInput = userMessage + '\\n\\n<user_context>\\ntelegram_user_id: ' + telegramUserId + '\\nname: ' + (userProfile.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nage: ' + (userProfile.age || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nheight_cm: ' + (userProfile.height_cm || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nweight_kg: ' + (userProfile.weight_kg || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\ngoal: ' + goalRu + '\\ntimezone: ' + (userProfile.timezone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '\\nprotein_goal: ' + (userProfile.protein_goal || 0) + '\\ncarbs_goal: ' + (userProfile.carbs_goal || 0) + '\\nfat_goal: ' + (userProfile.fat_goal || 0) + '\\nfiber_goal: ' + (userProfile.fiber_goal || 0) + '\\nwater_goal_ml: ' + (userProfile.water_goal_ml || 0) + '\\ncalorie_goal: ' + (userProfile.calorie_goal || 0) + '\\n</user_context>';\n}\n\n// === BUILD OUTPUT ===\nconst output = {\n  chatInput: chatInput,\n  user_id: userProfile.id,\n  telegram_user_id: telegramUserId\n};\n\nif (inSessionMode) {\n  output.session_mode = session.active_command;\n}\n\nreturn output;"
        },
        "id": "inject-context-001",
        "name": "Inject Context",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1200,
          352
        ]
      },
      {
        "parameters": {
          "toolDescription": "Search user's food entries by product name and optional date range.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_food_by_product",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_search_text"
              },
              {
                "name": "p_start_date",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_end_date",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID",
                "type": "number"
              },
              {
                "name": "p_search_text",
                "description": "Food product name to search for",
                "type": "string"
              },
              {
                "name": "p_start_date",
                "description": "Start date in YYYY-MM-DD format",
                "type": "string"
              },
              {
                "name": "p_end_date",
                "description": "End date in YYYY-MM-DD format",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-search-food-product-001",
        "name": "Search Food by Product",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          2288,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Find similar food entries from user's history.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_similar_entries",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_search_text"
              },
              {
                "name": "p_limit",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID",
                "type": "number"
              },
              {
                "name": "p_search_text",
                "description": "Food item name to search",
                "type": "string"
              },
              {
                "name": "p_limit",
                "description": "Maximum results (default 5)",
                "type": "number"
              }
            ]
          }
        },
        "id": "tool-search-similar-001",
        "name": "Search Similar Entries",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          2576,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Get all food entries for a specific date.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_today_entries",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_date",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID",
                "type": "number"
              },
              {
                "name": "p_date",
                "description": "Date in YYYY-MM-DD format",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-search-today-001",
        "name": "Search Today Entries",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          2736,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Get daily nutrition summary.\n\nUSE THIS when user asks for: /day, –¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞, —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ, daily report.\n\nALSO USE THIS FOR /week COMMAND:\n- For /week, call this tool 7 times (once per day for last 7 days)\n- Each call needs p_telegram_user_id AND p_date (YYYY-MM-DD)\n- Aggregate all results: SUM entry counts, SUM all macros\n- Calculate averages: total / 7\n\nREQUIRED PARAMETERS:\n- p_telegram_user_id (number): User's Telegram ID from context\n- p_date (YYYY-MM-DD): Date for the summary - ALWAYS provide, use today if not specified\n\nRETURNS: calories, protein, carbs, fat, fiber, water, entry_count, food entries for specified date.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/get_daily_summary",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_date"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "Users Telegram ID",
                "type": "number"
              },
              {
                "name": "p_date",
                "description": "Date for the summary in YYYY-MM-DD format. REQUIRED - always provide todays date if user doesnt specify",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-daily-summary-001",
        "name": "Get Daily Summary",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          2896,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Update user's daily nutrition goals.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_goals_bulk",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_protein_goal",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_carbs_goal",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_fat_goal",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_fiber_goal",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_water_goal_ml",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_calorie_goal",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User Telegram ID",
                "type": "number"
              },
              {
                "name": "p_protein_goal",
                "description": "Daily protein goal in grams (optional)",
                "type": "number"
              },
              {
                "name": "p_carbs_goal",
                "description": "Daily carbs goal in grams (optional)",
                "type": "number"
              },
              {
                "name": "p_fat_goal",
                "description": "Daily fat goal in grams (optional)",
                "type": "number"
              },
              {
                "name": "p_fiber_goal",
                "description": "Daily fiber goal in grams (optional)",
                "type": "number"
              },
              {
                "name": "p_water_goal_ml",
                "description": "Daily water goal in ml (optional)",
                "type": "number"
              },
              {
                "name": "p_calorie_goal",
                "description": "Custom daily calorie goal (optional)",
                "type": "number"
              }
            ]
          }
        },
        "id": "tool-update-goal-001",
        "name": "Update User Goal",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          2144,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {},
        "id": "execute-subworkflow-trigger-001",
        "name": "Execute Sub-workflow Trigger",
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1,
        "position": [
          -1136,
          320
        ]
      },
      {
        "parameters": {
          "toolDescription": "Delete a specific food entry by its ID.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/delete_food_entry",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_entry_id"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID",
                "type": "number"
              },
              {
                "name": "p_entry_id",
                "description": "UUID of the food entry to delete",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-delete-food-entry-001",
        "name": "Delete Food Entry",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          1984,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Log water intake in milliliters.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/log_water_intake",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_amount_ml"
              },
              {
                "name": "p_intake_date",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID",
                "type": "number"
              },
              {
                "name": "p_amount_ml",
                "description": "Water amount in milliliters",
                "type": "number"
              },
              {
                "name": "p_intake_date",
                "description": "Date in YYYY-MM-DD format",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-log-water-001",
        "name": "Log Water Intake",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          1824,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const output = $input.first().json.output || '';\n\nconst signatures = [\n  /This message was sent automatically with n8n\\.?\\s*/gi,\n  /This message was sent automatically\\.?\\s*/gi,\n  /Sent via n8n\\.?\\s*/gi,\n  /Sent automatically with n8n\\.?\\s*/gi,\n  /Powered by n8n\\.?\\s*/gi,\n  /Generated with n8n\\.?\\s*/gi,\n  /Generated by n8n\\.?\\s*/gi,\n  /\\n*-+\\s*This message.*$/gi,\n  /\\n*\\*This message.*$/gi,\n  /\\n{2,}This message\\..*$/gi,\n  /\\n*---+\\s*$/g,\n  /\\n*\\*{3,}\\s*$/g\n];\n\nlet cleaned = output;\n\nsignatures.forEach(pattern => {\n  cleaned = cleaned.replace(pattern, '');\n});\n\ncleaned = cleaned.trim();\ncleaned = cleaned.replace(/\\n{3,}/g, '\\n\\n');\n\nconst signatureRemoved = output !== cleaned;\n\nreturn [{ \n  json: { \n    output: cleaned,\n    original_output: signatureRemoved ? output : undefined,\n    signature_removed: signatureRemoved\n  } \n}];"
        },
        "id": "strip-signature-001",
        "name": "Strip Signature",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1696,
          144
        ]
      },
      {
        "parameters": {
          "jsCode": "const message = $input.item.json.message;\nconst command = message.text;\nconst chat_id = message.chat.id;\nconst telegram_user_id = message.from.id;\n\n// Commands that need AI Agent processing\nconst needsAIAgent = [\n  '/welcome', '/settings', '/start', '/meals', '/timezone',\n  '/week', '/stats', '/day', '/report', '/month'\n];\n\n// Check if any needsAI command matches (for commands that may have args)\nconst needsAI = needsAIAgent.some(cmd => command.startsWith(cmd));\n\nlet output = '';\n\n// Command handlers\nif (command === '/help') {\n  output = `ü§ñ **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º**\n\nüìù **–ó–∞–ø–∏—Å—å –µ–¥—ã:**\n‚Ä¢ –¢–µ–∫—Å—Ç–æ–º: \"200–≥ –∫—É—Ä–∏—Ü—ã\" –∏–ª–∏ \"—è–±–ª–æ–∫–æ\"\n‚Ä¢ –ì–æ–ª–æ—Å–æ–º: –æ—Ç–ø—Ä–∞–≤—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n‚Ä¢ –§–æ—Ç–æ: —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –±–ª—é–¥–æ\n\nüìä **–û—Ç—á—ë—Ç—ã:**\n‚Ä¢ /day - –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç (% –æ—Ç —Ü–µ–ª–∏)\n‚Ä¢ /week - –Ω–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n‚Ä¢ /month - –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç —Å —Ç—Ä–µ–Ω–¥–∞–º–∏\n\nüíß **–í–æ–¥–∞:**\n–ù–∞–ø–∏—à–∏ \"200–º–ª –≤–æ–¥—ã\" –∏–ª–∏ \"—Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã\"\n\n‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**\n‚Ä¢ /settings - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–≤–µ—Å, —Ü–µ–ª—å, –º–∞–∫—Ä–æ—Å—ã)\n‚Ä¢ /welcome - –ø—Ä–æ–π—Ç–∏ onboarding –∑–∞–Ω–æ–≤–æ\n\nüìã **–®–∞–±–ª–æ–Ω—ã:**\n‚Ä¢ /meals - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –±–ª—é–¥\n\nüåç **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:**\n–í—Ä–µ–º—è –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è /welcome`;\n} else if (command === '/start') {\n  output = '–ü—Ä–∏–≤–µ—Ç! –Ø FoodTracker –±–æ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π /help —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.';\n} else if (command === '/settings') {\n  output = '–ó–∞–≥—Ä—É–∂–∞—é —Ç–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...';\n} else if (command === '/welcome') {\n  output = '–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å onboarding...';\n} else if (command === '/meals') {\n  output = '–ó–∞–≥—Ä—É–∂–∞—é —à–∞–±–ª–æ–Ω—ã –±–ª—é–¥...';\n} else if (command.startsWith('/day') || command.startsWith('/report')) {\n  output = 'üìä –§–æ—Ä–º–∏—Ä—É—é –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç...';\n} else if (command.startsWith('/week') || command.startsWith('/stats')) {\n  output = 'üìà –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é –Ω–µ–¥–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...';\n} else if (command.startsWith('/month')) {\n  output = 'üìÖ –§–æ—Ä–º–∏—Ä—É—é –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç...';\n} else {\n  output = `–ö–æ–º–∞–Ω–¥–∞ ${command} –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.`;\n}\n\nreturn {\n  json: {\n    output: output,\n    chat_id: chat_id,\n    telegram_user_id: telegram_user_id,\n    command: command,\n    needsAI: needsAI\n  }\n};"
        },
        "id": "simple-reply-001",
        "name": "Simple Reply",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          64,
          -416
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "route-check",
                "leftValue": "={{ $json.needsAI }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "route-to-ai-check-001",
        "name": "Route to AI?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          288,
          -416
        ]
      },
      {
        "parameters": {
          "toolDescription": "Updates user's timezone.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_timezone",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_timezone"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID number",
                "type": "number"
              },
              {
                "name": "p_timezone",
                "description": "IANA timezone string",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-update-timezone-001",
        "name": "Update User Timezone",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          3040,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Add new meal to user's personal meal library.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/add_user_meal_flat",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_user_id"
              },
              {
                "name": "p_meal_name"
              },
              {
                "name": "p_slang_names",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_calories_per_100g"
              },
              {
                "name": "p_protein_per_100g"
              },
              {
                "name": "p_carbs_per_100g"
              },
              {
                "name": "p_fat_per_100g"
              },
              {
                "name": "p_fiber_per_100g",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_default_portion_g",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_portion_name",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_user_id",
                "description": "Telegram user ID",
                "type": "number"
              },
              {
                "name": "p_meal_name",
                "description": "Full meal name in Russian",
                "type": "string"
              },
              {
                "name": "p_slang_names",
                "description": "Comma-separated slang names",
                "type": "string"
              },
              {
                "name": "p_calories_per_100g",
                "description": "Calories per 100g",
                "type": "number"
              },
              {
                "name": "p_protein_per_100g",
                "description": "Protein grams per 100g",
                "type": "number"
              },
              {
                "name": "p_carbs_per_100g",
                "description": "Carbohydrates grams per 100g",
                "type": "number"
              },
              {
                "name": "p_fat_per_100g",
                "description": "Fat grams per 100g",
                "type": "number"
              },
              {
                "name": "p_fiber_per_100g",
                "description": "Fiber grams per 100g",
                "type": "number"
              },
              {
                "name": "p_default_portion_g",
                "description": "Default portion size in grams",
                "type": "number"
              },
              {
                "name": "p_portion_name",
                "description": "Portion description",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-add-user-meal-001",
        "name": "Add User Meal",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          3184,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Search user's personal meal library by meal name or ingredients.\n\nCRITICAL INSTRUCTION: When user mentions a food item in ANY grammatical form, extract the ROOT/STEM before searching:\n- \"—Å —è–π—Ü–∞–º–∏\" -> search \"—è–π—Ü\"\n- \"—Å –±–µ–∫–æ–Ω–æ–º\" -> search \"–±–µ–∫–æ–Ω\"\n- \"–±–ª—é–¥–æ —Å –∫—É—Ä–∏—Ü–µ–π\" -> search \"–∫—É—Ä–∏—Ü\"\n\nRussian language has 6 cases - search must use word root to match nominative form in database.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/search_user_meals",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_user_id"
              },
              {
                "name": "p_query"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_user_id",
                "description": "User's Telegram ID",
                "type": "number"
              },
              {
                "name": "p_query",
                "description": "Search query (meal name or ingredient)",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-search-user-meals-001",
        "name": "Search User Meals",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          3344,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Update existing meal in user's library.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_meal",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_meal_id"
              },
              {
                "name": "p_updates"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_meal_id",
                "description": "UUID of the meal to update",
                "type": "string"
              },
              {
                "name": "p_updates",
                "description": "JSONB object with fields to update",
                "type": "object"
              }
            ]
          }
        },
        "id": "tool-update-user-meal-001",
        "name": "Update User Meal",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          3504,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Delete a meal from user's personal library.\n\nWORKFLOW (MANDATORY):\n1. FIRST call Search User Meals tool to find the meal by name\n2. Extract meal_id from search result\n3. THEN call this tool with the meal_id parameter\n\nExample: User says \"–£–¥–∞–ª–∏ –Ø–∏—á–Ω–∏—Ü—É\"\n- Step 1: search_user_meals(p_query=\"–Ø–∏—á–Ω–∏—Ü\")\n- Step 2: Get meal_id from result (e.g., \"abc-123\")\n- Step 3: delete_user_meal(p_meal_id=\"abc-123\")",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/delete_user_meal",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_meal_id"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_meal_id",
                "description": "UUID of the meal to delete",
                "type": "string"
              }
            ]
          }
        },
        "id": "tool-delete-user-meal-001",
        "name": "Delete User Meal",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          3664,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Get monthly nutrition summary. USE THIS when user asks for: /month, –º–µ—Å—è—á–Ω–∞—è —Å–≤–æ–¥–∫–∞, –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç, monthly report. Returns: 30-day averages, trends, achievements, compliance stats.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/get_monthly_summary",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_year",
                "valueProvider": "modelOptional"
              },
              {
                "name": "p_month",
                "valueProvider": "modelOptional"
              }
            ]
          },
          "placeholderDefinitions": {
            "values": [
              {
                "name": "p_telegram_user_id",
                "description": "User's Telegram ID number",
                "type": "number"
              },
              {
                "name": "p_year",
                "description": "Year for the report",
                "type": "number"
              },
              {
                "name": "p_month",
                "description": "Month 1-12 for the report",
                "type": "number"
              }
            ]
          }
        },
        "id": "tool-get-monthly-summary-001",
        "name": "Get Monthly Summary",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          1680,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "toolDescription": "Updates user profile and macro goals during onboarding. Saves 13 parameters: telegram_user_id, name, age, height_cm, weight_kg, goal, calories_goal (user-provided), protein_goal, carbs_goal, fat_goal, fiber_goal, water_goal_ml, timezone. NO auto-calculation - saves exact calories value provided by user.",
          "method": "POST",
          "url": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/update_user_onboarding",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "supabaseApi",
          "sendBody": true,
          "parametersBody": {
            "values": [
              {
                "name": "p_telegram_user_id"
              },
              {
                "name": "p_name"
              },
              {
                "name": "p_age"
              },
              {
                "name": "p_height_cm"
              },
              {
                "name": "p_weight_kg"
              },
              {
                "name": "p_goal"
              },
              {
                "name": "p_calories_goal"
              },
              {
                "name": "p_protein_goal"
              },
              {
                "name": "p_carbs_goal"
              },
              {
                "name": "p_fat_goal"
              },
              {
                "name": "p_fiber_goal"
              },
              {
                "name": "p_water_goal_ml"
              },
              {
                "name": "p_timezone"
              }
            ]
          },
          "optimizeResponse": null
        },
        "id": "tool-update-onboarding-001",
        "name": "Update User Onboarding",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "typeVersion": 1.1,
        "position": [
          3824,
          1248
        ],
        "credentials": {
          "supabaseApi": {
            "id": "DYpIGQK8a652aosj",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.telegram.org/bot{{ env.TELEGRAM_BOT_TOKEN }}/sendMessage",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ JSON.stringify({ chat_id: $node[\"Telegram Trigger\"].json.message.chat.id, text: $node[\"Strip Signature\"].json.output || $node[\"Simple Reply\"].json.output, reply_markup: { keyboard: [[{ text: \"‚û°Ô∏è –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ\" }]], resize_keyboard: true, one_time_keyboard: false } }) }}",
          "options": {}
        },
        "id": "http-send-keyboard-001",
        "name": "Send Keyboard (HTTP)",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2176,
          144
        ]
      },
      {
        "parameters": {
          "jsCode": "const input = $input.first().json;\nconst telegramUserId = input.telegram_user_id;\n\nif (!telegramUserId) {\n  throw new Error('[WEEK CALCULATIONS] telegram_user_id not found in input');\n}\n\n// Supabase configuration\nconst supabaseUrl = 'https://qyemyvplvtzpukvktkae.supabase.co';\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5ZW15dnBsdnR6cHVrdmt0a2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTk3MzAsImV4cCI6MjA3NTg5NTczMH0.Dn33ZmQFYccuGNAAbjTe6ILDvSQlO45yanNpNvaCUrw';\n\n// Calculate last 7 days (including today)\nconst dates = [];\nconst today = new Date();\nfor (let i = 6; i >= 0; i--) {\n  const date = new Date(today);\n  date.setDate(date.getDate() - i);\n  dates.push(date.toISOString().split('T')[0]);\n}\n\nconsole.log('[WEEK CALCULATIONS] Fetching data for dates:', dates);\n\n// Fetch daily summaries for all 7 days\nconst dailyData = [];\nfor (const dateStr of dates) {\n  try {\n    const response = await $helpers.httpRequest({\n      method: 'POST',\n      url: supabaseUrl + '/rest/v1/rpc/get_daily_summary',\n      headers: {\n        'apikey': supabaseKey,\n        'Content-Type': 'application/json',\n        'Authorization': 'Bearer ' + supabaseKey\n      },\n      body: {\n        p_telegram_user_id: telegramUserId,\n        p_date: dateStr\n      }\n    });\n    \n    dailyData.push({\n      date: dateStr,\n      data: response\n    });\n  } catch (error) {\n    console.error('[WEEK CALCULATIONS] Error fetching ' + dateStr + ':', error.message);\n    dailyData.push({\n      date: dateStr,\n      data: {\n        totals: { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 },\n        water: { total_ml: 0 },\n        entries: []\n      }\n    });\n  }\n}\n\n// Aggregate totals\nlet totalEntries = 0;\nlet totalCalories = 0;\nlet totalProtein = 0;\nlet totalCarbs = 0;\nlet totalFat = 0;\nlet totalFiber = 0;\nlet totalWater = 0;\nlet daysWithData = 0;\n\nfor (const day of dailyData) {\n  const entryCount = day.data?.entries?.length || 0;\n  totalEntries += entryCount;\n  \n  if (entryCount > 0) {\n    daysWithData++;\n  }\n  \n  totalCalories += parseFloat(day.data?.totals?.calories) || 0;\n  totalProtein += parseFloat(day.data?.totals?.protein) || 0;\n  totalCarbs += parseFloat(day.data?.totals?.carbs) || 0;\n  totalFat += parseFloat(day.data?.totals?.fat) || 0;\n  totalFiber += parseFloat(day.data?.totals?.fiber) || 0;\n  totalWater += parseFloat(day.data?.water?.total_ml) || 0;\n}\n\n// Calculate averages (per day)\nconst avgCalories = Math.round(totalCalories / 7);\nconst avgProtein = Math.round(totalProtein / 7);\nconst avgCarbs = Math.round(totalCarbs / 7);\nconst avgFat = Math.round(totalFat / 7);\nconst avgFiber = Math.round(totalFiber / 7);\nconst avgWater = Math.round(totalWater / 7);\n\n// Return structured data for AI Agent\nreturn [{\n  json: {\n    weekStats: {\n      date_range: {\n        start: dates[0],\n        end: dates[6]\n      },\n      totals: {\n        entries: totalEntries,\n        days_with_data: daysWithData,\n        calories: Math.round(totalCalories),\n        protein: Math.round(totalProtein),\n        carbs: Math.round(totalCarbs),\n        fat: Math.round(totalFat),\n        fiber: Math.round(totalFiber),\n        water: Math.round(totalWater)\n      },\n      averages: {\n        calories: avgCalories,\n        protein: avgProtein,\n        carbs: avgCarbs,\n        fat: avgFat,\n        fiber: avgFiber,\n        water: avgWater\n      },\n      daily_breakdown: dailyData.map(d => ({\n        date: d.date,\n        entries: d.data?.entries?.length || 0,\n        calories: Math.round(d.data?.totals?.calories || 0)\n      }))\n    },\n    telegram_user_id: telegramUserId,\n    command: input.command,\n    data: input.data,\n    calculation_source: 'deterministic_code'\n  }\n}];"
        },
        "id": "week-calculations-code-001",
        "name": "Week Calculations Code",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          512,
          -416
        ]
      }
    ],
    "connections": {
      "Telegram Trigger": {
        "main": [
          [
            {
              "node": "Log Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Log Message": {
        "main": [
          [
            {
              "node": "Check User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check User": {
        "main": [
          [
            {
              "node": "IF Registered",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IF Registered": {
        "main": [
          [
            {
              "node": "Typing Indicator",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Not Registered",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Typing Indicator": {
        "main": [
          [
            {
              "node": "Prepare Message Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Message Data": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Process Voice",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Process Photo",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Simple Reply",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Process Text",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Simple Reply": {
        "main": [
          [
            {
              "node": "Route to AI?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Text": {
        "main": [
          [
            {
              "node": "Inject Context",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Voice": {
        "main": [
          [
            {
              "node": "Download Voice",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download Voice": {
        "main": [
          [
            {
              "node": "Transcribe Voice",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcribe Voice": {
        "main": [
          [
            {
              "node": "Merge Voice Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge Voice Data": {
        "main": [
          [
            {
              "node": "Inject Context",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Photo": {
        "main": [
          [
            {
              "node": "Download Photo",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download Photo": {
        "main": [
          [
            {
              "node": "Extract Barcode",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract Barcode": {
        "main": [
          [
            {
              "node": "Parse Barcode Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Barcode Result": {
        "main": [
          [
            {
              "node": "IF Has Barcode",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IF Has Barcode": {
        "main": [
          [
            {
              "node": "Get OpenFoodFacts",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Restore Binary for Vision",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get OpenFoodFacts": {
        "main": [
          [
            {
              "node": "Parse OpenFoodFacts",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse OpenFoodFacts": {
        "main": [
          [
            {
              "node": "IF OpenFoodFacts Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IF OpenFoodFacts Success": {
        "main": [
          [
            {
              "node": "Merge Photo Paths",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Restore Binary for UPC",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Restore Binary for UPC": {
        "main": [
          [
            {
              "node": "Get UPC Database",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get UPC Database": {
        "main": [
          [
            {
              "node": "Parse UPC Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse UPC Response": {
        "main": [
          [
            {
              "node": "IF UPC Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IF UPC Success": {
        "main": [
          [
            {
              "node": "Merge Photo Paths",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Restore Binary for Vision",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Restore Binary for Vision": {
        "main": [
          [
            {
              "node": "Vision Analysis",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Vision Analysis": {
        "main": [
          [
            {
              "node": "Parse Vision Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Vision Result": {
        "main": [
          [
            {
              "node": "Merge Photo Paths",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge Photo Paths": {
        "main": [
          [
            {
              "node": "Inject Context",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Inject Context": {
        "main": [
          [
            {
              "node": "AI Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent": {
        "main": [
          [
            {
              "node": "Strip Signature",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Keyboard (HTTP)": {
        "main": [
          [
            {
              "node": "Save AI Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Save AI Response": {
        "main": [
          [
            {
              "node": "Save User Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Execute Sub-workflow Trigger": {
        "main": [
          [
            {
              "node": "Log Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Route to AI?": {
        "main": [
          [
            {
              "node": "Week Calculations Code",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send Keyboard (HTTP)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Conversation Memory": {
        "ai_memory": [
          [
            {
              "node": "AI Agent",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "Save Food Entry": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Search Food by Product": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Search Similar Entries": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Search Today Entries": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get Daily Summary": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Update User Goal": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Delete Food Entry": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Log Water Intake": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Update User Timezone": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Add User Meal": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Search User Meals": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Update User Meal": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Delete User Meal": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Get Monthly Summary": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Update User Onboarding": {
        "ai_tool": [
          [
            {
              "node": "AI Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Week Calculations Code": {
        "main": [
          [
            {
              "node": "Inject Context",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Strip Signature": {
        "main": [
          [
            {
              "node": "Send Keyboard (HTTP)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Sergey Novikov",
    "name": null,
    "description": null,
    "workflowPublishHistory": [
      {
        "createdAt": "2025-12-23T02:31:37.990Z",
        "id": 140,
        "workflowId": "sw3Qs3Fe3JahEbbW",
        "versionId": "00fedb66-8a87-46a2-939c-7536aea2d94a",
        "event": "activated",
        "userId": "ce467fe1-138e-46ea-871a-373796fc5618"
      }
    ]
  }
}
